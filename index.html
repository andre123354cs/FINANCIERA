<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROCESOS YESBPO | M√≥dulos Integrados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { background-color: #f4f7f6; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1400px; margin-top: 20px; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); flex-grow: 1; }
        .section-panel { padding: 15px; border: 1px solid #e0e0e0; border-radius: 0.25rem; margin-bottom: 20px; }
        .step-divider { border-top: 4px solid #0d6efd; margin-top: 30px; margin-bottom: 30px; padding-top: 15px; }
        h1 { color: #0d6efd; font-weight: 700; margin-bottom: 30px; }
        .section-title { font-size: 1.5rem; color: #495057; border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 20px; }
        .module-nav button { transition: all all 0.3s ease; font-weight: 600; font-size: 1.1rem; border-radius: 0.5rem; border: 2px solid #0d6efd; background-color: #ffffff; color: #0d6efd; }
        .module-nav button.active { background-color: #0d6efd; color: #ffffff; box-shadow: 0 4px 8px rgba(13, 110, 253, 0.5); }
        .module-nav button:hover:not(.active) { background-color: #e9f0ff; color: #0b5ed7; }
        .hidden-preview { display: none !important; }
        .hidden-filters select, .hidden-filters button { display: none !important; } 
        .footer { padding: 15px 0; background-color: #e9ecef; color: #6c757d; text-align: center; margin-top: 20px; font-size: 0.85rem; }
    </style>
</head>
<body onload="Comfama_loadCacheOnStart()"> <div class="container">
    <h1 class="text-center">PROCESOS YESBPO</h1>
    
    <div class="d-flex flex-wrap justify-content-center gap-3 mb-4 module-nav" role="tablist">
        <button class="btn px-4 py-2 active" id="comfama-tab" data-bs-toggle="tab" data-bs-target="#comfama" type="button" role="tab" aria-controls="comfama" aria-selected="true">
            Comfama Financiera üè¶
        </button>
        <button class="btn px-4 py-2" id="azzorti-tab" data-bs-toggle="tab" data-bs-target="#azzorti" type="button" role="tab" aria-controls="azzorti" aria-selected="false">
            Azzorti üëï
        </button>
        <button class="btn px-4 py-2" id="otra-tab" data-bs-toggle="tab" data-bs-target="#otra" type="button" role="tab" aria-controls="otra" aria-selected="false">
            Otro M√≥dulo ‚ú®
        </button>
    </div>

    <div class="tab-content" id="processTabsContent">
        
        <div class="tab-pane fade show active" id="comfama" role="tabpanel" aria-labelledby="comfama-tab">
            <div class="alert alert-warning py-2 mb-4" id="cacheStatus" style="display:none;"></div>
            <div id="pagosSection" class="section-panel">
                <div class="section-title text-success">1. Carpeta de Pagos (Consolidaci√≥n y Cach√©)</div>
                <p class="fw-bold">1.1 Carga de Carpeta de Pagos</p>
                <input type="file" webkitdirectory directory multiple class="form-control mb-3" id="pagosFolderInput">
                <div class="alert alert-info py-1" id="pagosStatus">Cargue la **Carpeta de Pagos** para Consolidaci√≥n. *Este paso debe finalizar antes del Paso 2.*</div>
                <div class="alert alert-light mt-2 py-1" id="pagosProcessStatus" style="display:none;"></div>
                <div class="progress mb-2" id="pagosProgressBarContainer" style="height: 25px; display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="pagosProgressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
            </div>
            <div class="section-panel step-divider">
                <div class="section-title">2. Carpeta de Asignaciones (Limpieza y Cruce)</div>
                <p class="fw-bold">2.1 Carga de Carpeta de Asignaciones (Principal)</p>
                <input type="file" webkitdirectory directory multiple class="form-control mb-3" id="folderInput" disabled>
                <div class="alert alert-info py-1" id="anexoStatus">Espere a que el Paso 1 finalice para cargar aqu√≠.</div>
                <p class="fw-bold mt-4">2.2 Proceso Autom√°tico (Limpieza y Cruce)</p>
                <div class="alert alert-light mt-2 py-1" id="dedupeStatus" style="display:none;"></div>
                <div class="progress mb-2" id="asignacionesProgressBarContainer" style="height: 25px; display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" id="asignacionesProgressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
                    <button class="btn btn-primary btn-lg" onclick="downloadFile(Comfama_mergedData, 'resultado_cruce_final_comfama.csv', '|');" id="downloadMergeBtn" style="display:none;">Descargar Data</button>
                    <button id="downloadAnexoBtn" style="display:none;"></button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="azzorti" role="tabpanel" aria-labelledby="azzorti-tab">
            <div class="section-panel">
                <div class="section-title text-primary">1. Carga, Clasificaci√≥n y Procesamiento Autom√°tico</div> 
                <p class="fw-bold">1.1 Carga de Carpeta Principal (Incluye subcarpetas)</p>
                <input type="file" webkitdirectory directory multiple class="form-control mb-3" id="azzortiFolderInput">
                <div class="alert alert-info py-1" id="azzortiStatus">Cargue la **Carpeta Principal** de Azzorti. Se buscar√°n archivos TXT y el CSV llamado **CIERRES.csv**. El proceso iniciar√° autom√°ticamente.</div> 
                <p class="fw-bold mt-4">1.2 Resultados de la Clasificaci√≥n</p>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiNotesCount">Notas: 0 archivos</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiPagosCount">Pagos: 0 archivos</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiDeudCount">Deudas: 0 archivos</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiObliCount">Obligaciones: 0 archivos</div>
                    </div>
                    <div class="col-12 mb-2">
                        <div class="alert alert-warning py-1" id="cierreCampanaStatus">CSV Cierres: Pendiente de b√∫squeda en la carpeta.</div>
                    </div>
                </div>
            </div>

            <div class="section-panel step-divider">
                <div class="section-title text-success">2. Consolidaci√≥n, Cruce y Descargas</div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3" style="display:none;"> 
                    <button class="btn btn-success btn-lg" onclick="Azzorti_executeConsolidation();" id="azzortiProcessBtn" disabled>
                        Iniciar Consolidaci√≥n de Datos
                    </button>
                </div>

                <div class="alert alert-light mt-2 py-1" id="azzortiProcessStatus" style="display:none;"></div>

                <div class="progress mb-2" id="azzortiProgressBarContainer" style="height: 25px; display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" id="azzortiProgressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                
                <div class="mt-4 row g-3" id="azzortiDownloadButtons" style="display:none;">
                    <p class="fw-bold">Descarga de Archivos Consolidado:</p>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadNotasBtn" onclick="downloadFile(Azzorti_consolidatedData.Notas, 'Azzorti_Notas_Consolidado.csv', '|')" disabled>Notas</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadPagosBtn" onclick="downloadFile(Azzorti_consolidatedData.Pagos, 'Azzorti_Pagos_Consolidado.csv', '|')" disabled>Pagos (Limpio)</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadDeudBtn" onclick="downloadFile(Azzorti_consolidatedData.Deud, 'Azzorti_Deud_Consolidado.csv', '|')" disabled>Deudas</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadObliBtn" onclick="downloadFile(Azzorti_consolidatedData.Obli, 'Azzorti_Obli_Consolidado.csv', '|')" disabled>Obligaciones</button>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="col-12 d-flex flex-wrap gap-2">
                        <button class="btn btn-danger btn-lg" id="downloadCruzeBtn" onclick="downloadFile(Azzorti_consolidatedData.Cruze, 'Azzorti_Cruze_Deudas_Obligaciones.csv', '|')" disabled>
                            Descargar **CRUCE** Deudas vs. Obligaciones
                        </button>
                        
                        <button class="btn btn-primary btn-lg" id="downloadPagosCruzeBtn" onclick="downloadFile(Azzorti_consolidatedData.PagosCruze, 'Azzorti_Cruze_Pagos_Principal_AGREGADO.csv', '|')" disabled>
                            Descargar **CRUCE** Pagos vs. Principal
                        </button>
                        
                        <button class="btn btn-warning btn-lg" id="downloadCruzePagosFinalBtn" onclick="downloadFile(Azzorti_consolidatedData.CruzePagosFinal, 'Azzorti_CONSOLIDADO_FINAL.csv', '|')" disabled>
                            Descargar **CONSOLIDADO FINAL**
                        </button>
                        
                        <button class="btn btn-info btn-lg" id="downloadCruzeNotasFinalBtn" onclick="downloadFile(Azzorti_consolidatedData.CruzeNotasFinal, 'Azzorti_CRUCE_NOTAS_CONSOLIDADO.csv', '|')" disabled>
                            Descargar **CRUCE NOTAS** vs. Consolidado
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div class="tab-pane fade" id="otra" role="tabpanel" aria-labelledby="otra-tab">
            <div class="alert alert-secondary text-center py-4">
                <h4>Otro M√≥dulo (En Construcci√≥n)</h4>
                <p>Este espacio est√° reservado para futuros procesos de automatizaci√≥n.</p>
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    Autor√≠a: Andr√©s Vanegas - √Årea de Inteligencia YesBPO
</footer>

<script>
    // ----------------------------------------------------------------------
    // --- UTILIDADES GLOBALES ---
    // ----------------------------------------------------------------------
    function determineDelimiter(fileChunk) {
        if (fileChunk.includes('|')) return '|';
        if (fileChunk.includes(';')) return ';';
        return ',';
    }

    /**
     * Funci√≥n universal para descargar datos en formato CSV.
     */
    function downloadFile(data, filename, delimiter) {
        if (!data) {
            alert('No hay datos disponibles para descargar.');
            return;
        }

        const finalData = Array.isArray(data) ? data : data.data; 

        if (!finalData || finalData.length === 0) {
            alert('El conjunto de datos est√° vac√≠o.');
            return;
        }

        // Determinar si PapaParse ya gener√≥ la salida CSV (string) o si es un array de objetos
        let csv = '';
        if (typeof finalData === 'string') {
            csv = finalData;
        } else if (Array.isArray(finalData) && typeof finalData[0] === 'object') {
            // Si es un array de objetos, usar PapaParse para generar el CSV
            csv = Papa.unparse(finalData, {
                delimiter: delimiter || '|',
                header: true
            });
        } else {
            // Caso de arrays de arrays o dato inesperado
            alert('Formato de datos no reconocido para descarga.');
            return;
        }

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }


    // ----------------------------------------------------------------------
    // --- L√ìGICA COMFAMA FINANCIERA (Index (5).html) - Prefijado con Comfama_ ---
    // ----------------------------------------------------------------------
    let Comfama_db;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†
    const Comfama_CACHE_KEY_PAGOS = 'processedPagosData';

    let Comfama_dataFilePagos = null;¬† ¬†¬†
    let Comfama_processedDataAsignaciones = null;¬†
    let Comfama_mergedData = null;¬† ¬† ¬† ¬†

    const Comfama_folderInput = document.getElementById('folderInput');
    const Comfama_anexoStatus = document.getElementById('anexoStatus');
    const Comfama_dedupeStatus = document.getElementById('dedupeStatus');
    const Comfama_downloadMergeBtn = document.getElementById('downloadMergeBtn');
    const Comfama_pagosFolderInput = document.getElementById('pagosFolderInput');
    const Comfama_pagosStatus = document.getElementById('pagosStatus');
    const Comfama_pagosProcessStatus = document.getElementById('pagosProcessStatus');
    
    const Comfama_pagosProgressBar = document.getElementById('pagosProgressBar');
    const Comfama_pagosProgressBarContainer = document.getElementById('pagosProgressBarContainer');
    const Comfama_asignacionesProgressBar = document.getElementById('asignacionesProgressBar');
    const Comfama_asignacionesProgressBarContainer = document.getElementById('asignacionesProgressBarContainer');
    
    let Comfama_totalRowsCount = 0; 
    let Comfama_processedRowsCount = 0; 
    
    const Comfama_aggregatedPagosMap = new Map();
    const Comfama_aggregatedAsignacionesMap = new Map();
    
    // Nombres de Columnas (CONSTANTES)
    const Comfama_COL_DOC_PRIN = 'Numero Documento';
    const Comfama_COL_MES_PRIN = 'Mes data';
    const Comfama_COL_FECHA_PRIN = 'Nombre del archivo'; 
    const Comfama_COL_ANIO_PRIN = 'A√±o';
    const Comfama_COL_DOC_PAGOS = 'Numero de Documento';
    const Comfama_COL_MES_PAGOS = 'MES';
    const Comfama_COL_FECHA_MAX_PAGOS = 'Fecha_Movimiento_Maxima';
    const Comfama_COL_VALOR_PAGADO = 'Suma_Valor_Pagado';
    const Comfama_COL_VALOR_PAGADO_RAW = 'Valor Pagado';¬†
    const Comfama_COL_FECHA_MOV = 'Fecha Movimiento';¬†


    function Comfama_initDB() {
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) { 
                console.warn('IndexedDB no soportado. Cach√© deshabilitado.'); 
                return resolve(null); 
            }
            const request = window.indexedDB.open("ComfamaCacheDB", 1);
            request.onerror = (event) => { 
                console.error(`Error al abrir la base de datos: ${event.target.errorCode}`, event.target.error); 
                reject(event.target.error); 
            };
            request.onsuccess = (event) => { 
                Comfama_db = event.target.result; 
                resolve(Comfama_db); 
            };
            request.onupgradeneeded = (event) => {
                const dbInstance = event.target.result;
                if (!dbInstance.objectStoreNames.contains('dataStore')) { 
                    dbInstance.createObjectStore('dataStore', { keyPath: 'key' }); 
                }
            };
        });
    }

    function Comfama_saveDataToCache(key, data) {
        if (!Comfama_db) return Promise.resolve();
        return new Promise((resolve, reject) => {
            const transaction = Comfama_db.transaction(['dataStore'], 'readwrite');
            const store = transaction.objectStore('dataStore');
            const dataToStore = { key: key, data: data, timestamp: new Date() };
            const request = store.put(dataToStore);
            request.onsuccess = () => resolve();
            request.onerror = (event) => { 
                console.error('Error al guardar en cach√©.', event.target.error); 
                reject(event.target.error); 
            };
        });
    }

    function Comfama_loadDataFromCache(key) {
        if (!Comfama_db) return Promise.resolve(null);
        return new Promise((resolve, reject) => {
            const transaction = Comfama_db.transaction(['dataStore'], 'readonly');
            const store = transaction.objectStore('dataStore');
            const request = store.get(key);
            request.onsuccess = () => {
                const result = request.result;
                if (result && result.data && result.data.length > 0) {
                    Comfama_dataFilePagos = result.data;
                    document.getElementById('cacheStatus').textContent = `‚ö†Ô∏è Cach√© de Pagos cargada (${new Date(result.timestamp).toLocaleTimeString()}). Filas: ${Comfama_dataFilePagos.length.toLocaleString()}.`;
                    document.getElementById('cacheStatus').style.display = 'block';
                    Comfama_pagosStatus.textContent = `‚úÖ Data de Pagos (Cach√©) cargada. Filas: ${Comfama_dataFilePagos.length.toLocaleString()}. Lista para usar.`;
                    Comfama_pagosStatus.className = 'alert alert-success py-1';
                    Comfama_folderInput.disabled = false;
                    resolve(Comfama_dataFilePagos);
                } else {
                    document.getElementById('cacheStatus').style.display = 'none';
                    Comfama_pagosStatus.textContent = '‚ÑπÔ∏è Data de Pagos no encontrada en cach√©. Cargue la Carpeta de Pagos (Paso 1).';
                    Comfama_pagosStatus.className = 'alert alert-info py-1';
                    Comfama_folderInput.disabled = true;
                    resolve(null);
                }
            };
            request.onerror = (event) => { 
                console.error('Error al cargar el cach√©.', event.target.error); 
                resolve(null); 
            };
        });
    }

    async function Comfama_loadCacheOnStart() {
        try {
            await Comfama_initDB();
            await Comfama_loadDataFromCache(Comfama_CACHE_KEY_PAGOS);
        } catch (e) {
            console.error('Fallo grave al inicializar la base de datos de cach√©.', e);
        }
    }

    async function Comfama_executePagosProcess(files) {
        Comfama_aggregatedPagosMap.clear();
        Comfama_dataFilePagos = null;
        Comfama_folderInput.disabled = true;
        
        Comfama_pagosProgressBarContainer.style.display = 'block';
        Comfama_pagosProcessStatus.style.display = 'block';

        const totalFiles = files.length;
        let processedFiles = 0;

        for (const file of files) {
            await Comfama_processPagosFile(file, processedFiles, totalFiles);
            processedFiles++;
            const progress = Math.round((processedFiles / totalFiles) * 100);
            Comfama_pagosProgressBar.style.width = `${progress}%`;
            Comfama_pagosProgressBar.textContent = `${progress}%`;
        }

        const aggregatedArray = Array.from(Comfama_aggregatedPagosMap.values());
        Comfama_dataFilePagos = aggregatedArray;
        
        await Comfama_saveDataToCache(Comfama_CACHE_KEY_PAGOS, Comfama_dataFilePagos);

        Comfama_pagosProgressBarContainer.style.display = 'none';
        Comfama_pagosProcessStatus.style.display = 'none';
        
        Comfama_pagosStatus.textContent = `‚úÖ Proceso de Pagos finalizado. Registros consolidados: ${Comfama_dataFilePagos.length.toLocaleString()}. Data guardada en Cach√©.`;
        Comfama_pagosStatus.className = 'alert alert-success py-1';
        Comfama_folderInput.disabled = false;
        document.getElementById('cacheStatus').textContent = `‚ö†Ô∏è Cach√© de Pagos guardada (${new Date().toLocaleTimeString()}). Filas: ${Comfama_dataFilePagos.length.toLocaleString()}.`;
        document.getElementById('cacheStatus').style.display = 'block';
    }

    function Comfama_processPagosFile(file, fileIndex, totalFiles) {
        return new Promise((resolve, reject) => {
            Comfama_pagosProcessStatus.innerHTML = `‚öôÔ∏è Consolidando Pagos... (${fileIndex + 1}/${totalFiles}) - **${file.name}**`;

            const fileSizeLimit = 20 * 1024 * 1024; // 20 MB
            const isLargeFile = file.size > fileSizeLimit;
            const workerConfig = isLargeFile ? { worker: true } : {};

            const reader = new FileReader();
            reader.onload = (e) => {
                const fileChunk = e.target.result.substring(0, 1024);
                const delimiter = determineDelimiter(fileChunk);
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: delimiter,
                    ...workerConfig,
                    complete: (results) => {
                        let data = results.data;
                        let successCount = 0;
                        
                        if (data && data.length > 0) {
                            // Detecci√≥n de columnas
                            let originalKeyDoc = results.meta.fields.find(field => (field || '').trim() === Comfama_COL_DOC_PAGOS);
                            let originalKeyMes = results.meta.fields.find(field => (field || '').trim() === Comfama_COL_MES_PAGOS);
                            let originalKeyValor = results.meta.fields.find(field => (field || '').trim() === Comfama_COL_VALOR_PAGADO_RAW);
                            let originalKeyFecha = results.meta.fields.find(field => (field || '').trim() === Comfama_COL_FECHA_MOV);

                            if (!originalKeyDoc || !originalKeyMes || !originalKeyValor || !originalKeyFecha) {
                                Comfama_pagosProcessStatus.innerHTML += ` ‚ùå **ERROR:** Archivo **${file.name}** omitido. No se encontraron las columnas de Pagos: "${Comfama_COL_DOC_PAGOS}", "${Comfama_COL_MES_PAGOS}", "${Comfama_COL_VALOR_PAGADO_RAW}", "${Comfama_COL_FECHA_MOV}". (Delimitador: ${delimiter})`;
                                return resolve(); 
                            }
                            
                            data.forEach(row => {
                                const doc = String(row[originalKeyDoc] || '').trim();
                                const mes = String(row[originalKeyMes] || '').trim();
                                const valorRaw = String(row[originalKeyValor] || '').replace(/[$,\s]/g, '');
                                const fechaRaw = String(row[originalKeyFecha] || '').trim();
                                
                                const valor = parseFloat(valorRaw) || 0;
                                const key = `${doc}|${mes}`;
                                
                                if (doc && mes && valor > 0) {
                                    const currentDate = Comfama_aggregatedPagosMap.get(key);
                                    
                                    const newDate = new Date(fechaRaw);
                                    let maxDate = currentDate ? new Date(currentDate[Comfama_COL_FECHA_MAX_PAGOS]) : new Date(0);

                                    if (newDate > maxDate) {
                                        maxDate = newDate;
                                    }
                                    
                                    const newEntry = {
                                        [Comfama_COL_DOC_PAGOS]: doc,
                                        [Comfama_COL_MES_PAGOS]: mes,
                                        [Comfama_COL_VALOR_PAGADO]: (currentDate ? currentDate[Comfama_COL_VALOR_PAGADO] : 0) + valor,
                                        [Comfama_COL_FECHA_MAX_PAGOS]: maxDate.toLocaleDateString('es-CO', {day: '2-digit', month: '2-digit', year: 'numeric'})
                                    };

                                    Comfama_aggregatedPagosMap.set(key, newEntry);
                                    successCount++;
                                }
                            });
                        }
                        Comfama_pagosProcessStatus.innerHTML += ` (Rows: ${successCount.toLocaleString()})`;
                        resolve();
                    },
                    error: (error) => {
                        Comfama_pagosProcessStatus.innerHTML += ` ‚ùå **ERROR** en **${file.name}**: ${error.message}`;
                        resolve();
                    }
                });
            };
            reader.readAsText(file.slice(0, 1024)); // Lee un chunk para determinar el delimitador
        });
    }

    async function Comfama_executeAsignacionesPreProcess(files) {
        Comfama_processedDataAsignaciones = [];
        Comfama_mergedData = null;
        Comfama_aggregatedAsignacionesMap.clear();

        Comfama_asignacionesProgressBarContainer.style.display = 'block';
        Comfama_dedupeStatus.style.display = 'block';
        Comfama_dedupeStatus.textContent = 'Iniciando limpieza de asignaciones...';

        const totalFiles = files.length;
        let processedFiles = 0;

        for (const file of files) {
            await Comfama_processAsignacionesFile(file, processedFiles, totalFiles);
            processedFiles++;
            const progress = Math.round((processedFiles / totalFiles) * 100);
            Comfama_asignacionesProgressBar.style.width = `${progress}%`;
            Comfama_asignacionesProgressBar.textContent = `${progress}%`;
        }

        Comfama_asignacionesProgressBarContainer.style.display = 'none';
        Comfama_dedupeStatus.style.display = 'none';

        if (Comfama_processedDataAsignaciones.length > 0) {
            Comfama_anexoStatus.textContent = `‚úÖ Limpieza de asignaciones finalizada. Total de registros v√°lidos: ${Comfama_processedDataAsignaciones.length.toLocaleString()}.`;
            Comfama_anexoStatus.className = 'alert alert-success py-1';
            
            Comfama_executeMerge();
        } else {
            Comfama_anexoStatus.textContent = `‚ö†Ô∏è Limpieza de asignaciones finalizada. No se encontraron registros v√°lidos.`;
            Comfama_anexoStatus.className = 'alert alert-warning py-1';
            Comfama_downloadMergeBtn.style.display = 'none';
        }
    }

    function Comfama_processAsignacionesFile(file, fileIndex, totalFiles) {
        return new Promise((resolve, reject) => {
            Comfama_dedupeStatus.innerHTML = `‚öôÔ∏è Limpiando Asignaciones... (${fileIndex + 1}/${totalFiles}) - **${file.name}**`;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileChunk = e.target.result.substring(0, 1024);
                const delimiter = determineDelimiter(fileChunk);

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: delimiter,
                    complete: (results) => {
                        let data = results.data;
                        let successCount = 0;

                        if (data && data.length > 0) {
                            // Detecci√≥n de columnas
                            let originalKeyDoc = results.meta.fields.find(field => (field || '').trim() === Comfama_COL_DOC_PRIN);
                            let originalKeyMes = results.meta.fields.find(field => (field || '').trim() === Comfama_COL_MES_PRIN);

                            if (!originalKeyDoc || !originalKeyMes) {
                                Comfama_dedupeStatus.innerHTML += ` ‚ùå **ERROR:** Archivo **${file.name}** omitido. No se encontraron las columnas de Asignaciones: "${Comfama_COL_DOC_PRIN}" y "${Comfama_COL_MES_PRIN}". (Delimitador: ${delimiter})`;
                                return resolve(); 
                            }
                            
                            data.forEach(row => {
                                const doc = String(row[originalKeyDoc] || '').trim();
                                const mes = String(row[originalKeyMes] || '').trim();

                                if (doc && mes) {
                                    const key = `${doc}|${mes}`;
                                    // Conservar el registro de la carpeta que se carg√≥ de √∫ltimo (el m√°s reciente)
                                    if (!Comfama_aggregatedAsignacionesMap.has(key)) {
                                        // Agregar metadatos
                                        row[Comfama_COL_FECHA_PRIN] = file.name;
                                        row[Comfama_COL_ANIO_PRIN] = new Date().getFullYear().toString(); // Asume el a√±o actual
                                        Comfama_aggregatedAsignacionesMap.set(key, row);
                                        Comfama_processedDataAsignaciones.push(row);
                                        successCount++;
                                    }
                                }
                            });
                        }
                        Comfama_dedupeStatus.innerHTML += ` (Rows: ${successCount.toLocaleString()})`;
                        resolve();
                    },
                    error: (error) => {
                        Comfama_dedupeStatus.innerHTML += ` ‚ùå **ERROR** en **${file.name}**: ${error.message}`;
                        resolve();
                    }
                });
            };
            reader.readAsText(file.slice(0, 1024));
        });
    }

    function Comfama_executeMerge() {
        if (!Comfama_dataFilePagos || Comfama_dataFilePagos.length === 0) {
            alert("No hay datos de pagos en cach√©. Por favor, complete el Paso 1.");
            return;
        }

        if (!Comfama_processedDataAsignaciones || Comfama_processedDataAsignaciones.length === 0) {
            alert("No hay datos de asignaciones procesados. Por favor, cargue la carpeta en el Paso 2.");
            return;
        }

        Comfama_anexoStatus.textContent = '‚öôÔ∏è Iniciando cruce de datos (Asignaciones LEFT JOIN Pagos)...';
        Comfama_anexoStatus.className = 'alert alert-info py-1';

        const pagosMap = new Map();
        Comfama_dataFilePagos.forEach(row => {
            const key = `${row[Comfama_COL_DOC_PAGOS]}|${row[Comfama_COL_MES_PAGOS]}`;
            pagosMap.set(key, row);
        });

        Comfama_mergedData = Comfama_processedDataAsignaciones.map(asignacion => {
            const doc = String(asignacion[Comfama_COL_DOC_PRIN] || '').trim();
            const mes = String(asignacion[Comfama_COL_MES_PRIN] || '').trim();
            const key = `${doc}|${mes}`;
            
            const pagoMatch = pagosMap.get(key);

            if (pagoMatch) {
                return {
                    ...asignacion,
                    [Comfama_COL_VALOR_PAGADO]: pagoMatch[Comfama_COL_VALOR_PAGADO],
                    [Comfama_COL_FECHA_MAX_PAGOS]: pagoMatch[Comfama_COL_FECHA_MAX_PAGOS],
                    'Match_Pagos': 'SI'
                };
            } else {
                return {
                    ...asignacion,
                    [Comfama_COL_VALOR_PAGADO]: 0,
                    [Comfama_COL_FECHA_MAX_PAGOS]: 'N/A',
                    'Match_Pagos': 'NO'
                };
            }
        });

        Comfama_anexoStatus.textContent = `‚úÖ Cruce de datos finalizado. Registros finales: ${Comfama_mergedData.length.toLocaleString()}.`;
        Comfama_anexoStatus.className = 'alert alert-success py-1';
        Comfama_downloadMergeBtn.style.display = 'block';
    }
    
    // --- EVENT LISTENERS COMFAMA ---
    document.addEventListener('DOMContentLoaded', () => {
        Comfama_pagosFolderInput.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files).filter(file => file.size > 0 && (file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.txt')));
            if (files.length === 0) {
                Comfama_pagosStatus.textContent = 'No se encontraron archivos CSV/TXT v√°lidos en la carpeta.';
                Comfama_pagosStatus.className = 'alert alert-danger py-1';
                return;
            }
            Comfama_dataFilePagos = null;¬†
            Comfama_folderInput.disabled = true; 
            Comfama_downloadMergeBtn.style.display = 'none';¬†
            await Comfama_executePagosProcess(files);
        });

        Comfama_folderInput.addEventListener('change', async (event) => {
            if (Comfama_folderInput.disabled || !Comfama_dataFilePagos) {
                Comfama_anexoStatus.textContent = '‚ö†Ô∏è Debe completar el Paso 1 (Pagos) y esperar a que la data est√© en cach√©.';
                Comfama_anexoStatus.className = 'alert alert-danger py-1';
                return;
            }

            const files = Array.from(event.target.files).filter(file => file.size > 0 && (file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.txt')));
            if (files.length === 0) {
                Comfama_anexoStatus.textContent = 'No se encontraron archivos CSV/TXT v√°lidos en la carpeta.';
                Comfama_anexoStatus.className = 'alert alert-danger py-1';
                return;
            }
            
            Comfama_anexoStatus.textContent = `Archivos de Asignaciones listos. Iniciando proceso...`;
            Comfama_anexoStatus.className = 'alert alert-info py-1';
            
            Comfama_downloadMergeBtn.style.display = 'none';
            
            await Comfama_executeAsignacionesPreProcess(files);
        });
    });


    // ----------------------------------------------------------------------
    // --- L√ìGICA AZZORTI (Index (4).html) - Prefijado con Azzorti_ ---
    // ----------------------------------------------------------------------

    const Azzorti_folderInput = document.getElementById('azzortiFolderInput');
    const Azzorti_status = document.getElementById('azzortiStatus');
    const Azzorti_processBtn = document.getElementById('azzortiProcessBtn');
    const Azzorti_processStatus = document.getElementById('azzortiProcessStatus');
    const Azzorti_progressBar = document.getElementById('azzortiProgressBar');
    const Azzorti_progressBarContainer = document.getElementById('azzortiProgressBarContainer');
    const Azzorti_downloadButtons = document.getElementById('azzortiDownloadButtons');
    const Azzorti_cierreCampanaStatus = document.getElementById('cierreCampanaStatus');

    // Claves de identificaci√≥n para el cruce (Azzorti)
    const Azzorti_KEY_DEUD = 'NUMERO IDENTIFICACION'; 
    const Azzorti_KEY_OBLI = 'NUM. IDENTIFICACION'; 
    const Azzorti_KEY_PAGOS = 'NUM. IDENTIFICACION'; 
    const Azzorti_KEY_CRUZE_PAGOS = 'NUMERO IDENTIFICACION'; 
    
    let Azzorti_files = {
        'Notas': [],
        'Pagos': [],
        'Deud': [],
        'Obli': []
    };
    
    let Azzorti_consolidatedData = {
        'Notas': null,
        'Pagos': null,
        'Deud': null,
        'Obli': null,
        'Cruze': null, // Cruce D vs O + Salida
        'PagosCruze': null, // Cruce Pagos (Left) vs Cruze Principal + Validador + AGREGACI√ìN APTO
        'CruzePagosFinal': null, // Cruce Final (Cruze Principal Left Join Pagos Agregados APTO) + Saldo
        'CruzeNotasFinal': null // NUEVO: Cruce Notas (Left Join, Dedupe, Filter) vs Consolidado Final
    };
    
    // Almacenar√° los datos del CSV de Cierres (Map<Campanas|Corte, Salida>)
    let Azzorti_cierreCampanaMap = new Map(); 
    
    // Columnas a eliminar del resultado final
    const Azzorti_COLUMNS_TO_DELETE = [
        'Part_0', 'Part_1', 'Part_2', 'Part_3', 'Part_4', '_1', '_2', '_3'
    ];
    
    // Mapeo para renombrar columnas de metadatos (Parte de la l√≥gica interna de los archivos TXT)
    const Azzorti_RENAME_MAP = {
        'Part_5': 'Campanas', 
        'Part_6': 'Corte',
        'Part_7': 'Fecha Ingreso'
    };
    
    // Columnas a traer del archivo principal (Cruze Deudas vs Obligaciones) al cruzar con Pagos
    const Azzorti_CRUZE_COLUMNS_TO_IMPORT = [
        'Campanas', 
        'Fecha Ingreso',
        'Etapa', 
        'Salida'
    ];

    /**
     * Limpia una cadena (elimina acentos, √±, caracteres especiales y espacios).
     */
    function Azzorti_cleanString(str) {
        if (!str) return '';
        let cleaned = String(str).replace(/[\r\n]/g, '').trim();
        cleaned = cleaned.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        cleaned = cleaned.replace(/[^a-z0-9]/gi, ''); 
        return cleaned.toLowerCase();
    }
    
    /**
     * Estandariza la fecha de Azzorti de MM/DD/YYYY o MM-DD-YYYY a DD/MM/YYYY.
     */
    function Azzorti_standardizeDate(dateStr) {
        if (!dateStr) return '';
        let cleanedStr = String(dateStr).trim().replace(/[ \/\-]/g, '/'); 
        const parts = cleanedStr.split('/');
        
        if (parts.length === 3) {
            const month = parts[0].padStart(2, '0');
            const day = parts[1].padStart(2, '0');
            let year = parts[2];
            
            if (year.length === 2) {
                year = `20${year}`;
            }
            return `${day}/${month}/${year}`;
        }
        return cleanedStr;
    }

    /**
     * Convierte una fecha en formato DD/MM/YYYY a un objeto Date para comparaci√≥n.
     */
    function Azzorti_parseDateDDMMYYYY(dateStr) {
        if (!dateStr) return null;
        const parts = String(dateStr).split('/');
        if (parts.length !== 3) return null;
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);
        if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
        const date = new Date(Date.UTC(year, month - 1, day)); 
        if (date.getUTCFullYear() !== year || date.getUTCMonth() !== month - 1 || date.getUTCDate() !== day) {
            return null;
        }
        return date;
    }

    /**
     * Convierte una fecha en formato MM/DD/YYYY a un objeto Date para comparaci√≥n.
     */
    function Azzorti_parseDateMMDDYYYY(dateStr) {
        if (!dateStr) return null;
        const parts = String(dateStr).split('/');
        if (parts.length !== 3) return null;
        const month = parseInt(parts[0], 10);
        const day = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);
        if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
        const date = new Date(Date.UTC(year, month - 1, day)); 
        if (date.getUTCFullYear() !== year || date.getUTCMonth() !== month - 1 || date.getUTCDate() !== day) {
            return null;
        }
        return date;
    }
    
    /**
     * Extrae el n√∫mero entero de una cadena de izquierda a derecha antes del primer espacio.
     */
    function Azzorti_extractIntegerIdBeforeSpace(idString) {
        if (!idString) return '';
        const str = String(idString).trim();
        const spaceIndex = str.indexOf(' ');
        
        if (spaceIndex === -1) {
            return str; 
        }
        return str.substring(0, spaceIndex);
    }
    
    /**
     * Extrae el n√∫mero entero de una cadena de saldo (a la izquierda del primer punto).
     */
    function Azzorti_extractIntegerSaldo(saldoStr) {
        if (!saldoStr) return 0;
        const str = String(saldoStr).trim();
        const parts = str.split('.');
        
        let numericStr = parts[0].replace(/[^0-9\-]/g, ''); 
        
        return parseInt(numericStr) || 0;
    }

    function Azzorti_classifyFile(file) { 
        const nameLower = file.name.toLowerCase();
        
        if (nameLower.includes('notas')) {
            Azzorti_files.Notas.push(file);
        } else if (nameLower.includes('pagos')) {
            Azzorti_files.Pagos.push(file);
        } else if (nameLower.includes('deud')) {
            Azzorti_files.Deud.push(file);
        } else if (nameLower.includes('obli')) {
            Azzorti_files.Obli.push(file);
        }
    }

    /**
     * Actualiza los contadores de archivos.
     */
    function Azzorti_updateCounts() { 
        document.getElementById('azzortiNotesCount').innerHTML = `**Notas:** ${Azzorti_files.Notas.length} archivos`;
        document.getElementById('azzortiPagosCount').innerHTML = `**Pagos:** ${Azzorti_files.Pagos.length} archivos`;
        document.getElementById('azzortiDeudCount').innerHTML = `**Deudas:** ${Azzorti_files.Deud.length} archivos`;
        document.getElementById('azzortiObliCount').innerHTML = `**Obligaciones:** ${Azzorti_files.Obli.length} archivos`;
    }
    
    /**
     * Carga y parsea el archivo CSV de Cierres de Campa√±a. 
     */
    function Azzorti_loadCierreCampanaFile(file) {
        return new Promise((resolve) => {
            if (!file) {
                Azzorti_cierreCampanaMap.clear();
                return resolve();
            }
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                delimiter: '|', 
                complete: (results) => {
                    Azzorti_cierreCampanaMap.clear();
                    let successCount = 0;
                    const data = results.data;
                    
                    if (!results.meta.fields) { 
                         Azzorti_cierreCampanaStatus.textContent = '‚ö†Ô∏è CSV de Cierres est√° vac√≠o o no es un formato de delimitador v√°lido. (Formato: Campa√±as|Corte|Salida)';
                         Azzorti_cierreCampanaStatus.className = 'alert alert-warning py-1';
                         return resolve(); 
                    }
                    
                    let originalKeyCampanas = null;
                    let originalKeyCorte = null;
                    let originalKeySalida = null;
                    
                    // Detectar las columnas correctas
                    results.meta.fields.forEach(field => {
                        const originalField = String(field);
                        const cleanedField = Azzorti_cleanString(originalField);
                        if (cleanedField.includes('campan') && originalKeyCampanas === null) {
                            originalKeyCampanas = originalField;
                        } else if (cleanedField.includes('corte') && originalKeyCorte === null) {
                            originalKeyCorte = originalField;
                        } else if (cleanedField.includes('salida') && originalKeySalida === null) {
                            originalKeySalida = originalField;
                        }
                    });

                    if (!originalKeyCampanas || !originalKeyCorte || !originalKeySalida) {
                         Azzorti_cierreCampanaStatus.textContent = '‚ùå CSV de Cierres: No se encontraron las columnas requeridas (Campa√±as, Corte, Salida) o el delimitador "|" es incorrecto.';
                         Azzorti_cierreCampanaStatus.className = 'alert alert-danger py-1';
                         return resolve(); 
                    }
                    
                    data.forEach(row => {
                        const campana = String(row[originalKeyCampanas] || '').trim();
                        const corte = String(row[originalKeyCorte] || '').trim();
                        const salida = String(row[originalKeySalida] || '').trim();
                        
                        if (campana && corte && salida) {
                            const key = `${campana}|${corte}`;
                            Azzorti_cierreCampanaMap.set(key, salida);
                            successCount++;
                        }
                    });

                    if (successCount > 0) {
                        Azzorti_cierreCampanaStatus.textContent = `‚úÖ CSV de Cierres cargado. ${successCount.toLocaleString()} claves de cruce listas.`;
                        Azzorti_cierreCampanaStatus.className = 'alert alert-success py-1';
                    } else {
                        Azzorti_cierreCampanaStatus.textContent = '‚ö†Ô∏è CSV de Cierres cargado, pero no se encontraron filas v√°lidas (Campa√±as, Corte o Salida vac√≠as en los datos).';
                        Azzorti_cierreCampanaStatus.className = 'alert alert-warning py-1';
                    }
                    resolve();
                }, 
                error: (error) => {
                    Azzorti_cierreCampanaStatus.textContent = `‚ùå Error al parsear el CSV de Cierres. Aseg√∫rese de que el delimitador es '|'. (Detalle: ${error.message})`;
                    Azzorti_cierreCampanaStatus.className = 'alert alert-danger py-1';
                    Azzorti_cierreCampanaMap.clear();
                    resolve();
                }
            });
        });
    }

    /**
     * Procesa un grupo de archivos Azzorti: consolida, extrae metadatos y calcula Etapa. (MODIFICADO para Notas)
     */
    function Azzorti_processGroup(files, groupName, fileIndexOffset, totalAzzortiFiles) {
        return new Promise((resolve) => {
            if (files.length === 0) {
                Azzorti_processStatus.innerHTML += ` ‚ö†Ô∏è (Grupo **${groupName}** vac√≠o).`;
                return resolve([]);
            }

            let consolidatedData = [];
            let currentFileIndex = 0;
            
            const idKey = (groupName === 'Deud') ? Azzorti_KEY_DEUD : (groupName === 'Obli') ? Azzorti_KEY_OBLI : null;
            
            const processNextFile = () => {
                if (currentFileIndex >= files.length) {
                    Azzorti_processStatus.innerHTML += ` ‚úÖ Grupo **${groupName}** completado. Registros: ${consolidatedData.length.toLocaleString()}.`;
                    return resolve(consolidatedData);
                }
                
                const file = files[currentFileIndex];
                const totalProgressIndex = fileIndexOffset + currentFileIndex + 1;
                
                Azzorti_processStatus.innerHTML = `‚öôÔ∏è Consolidando **${groupName}**... (${totalProgressIndex}/${totalAzzortiFiles}) - **${file.name}**.`;
                
                const filePath = file.webkitRelativePath || file.name;
                const baseName = filePath.replace(/\.(txt|csv|dat)$/i, '').toLowerCase();
                const parts = baseName.split('_');
                const metadataObject = {};
                let rawCortePart = "";
                let rawFechaIngresoPart = "";
                
                parts.forEach((part, index) => {
                    const originalKey = `Part_${index}`;
                    const cleanedPart = part.trim();
                    
                    if (Azzorti_COLUMNS_TO_DELETE.includes(originalKey) || Azzorti_COLUMNS_TO_DELETE.includes(`_${index}`)) {
                        return;
                    }
                    
                    const finalKey = Azzorti_RENAME_MAP[originalKey] || originalKey;
                    
                    if (groupName !== 'Pagos') {
                        metadataObject[finalKey] = cleanedPart;
                        if (finalKey === 'Corte') {
                            rawCortePart = cleanedPart;
                        }
                        if (finalKey === 'Fecha Ingreso') {
                            rawFechaIngresoPart = cleanedPart;
                        }
                    }
                });

                let finalCorte = "";
                let finalEtapa = "";

                if (groupName !== 'Pagos') {
                    const isAdministrativa = (rawCortePart === "");
                    if (isAdministrativa) {
                        finalEtapa = "Administrativa";
                        finalCorte = "30";
                    } else {
                        finalEtapa = "Comercial";
                        finalCorte = rawCortePart;
                    }

                    const finalFechaIngreso = Azzorti_standardizeDate(rawFechaIngresoPart);

                    metadataObject['Corte'] = finalCorte;
                    metadataObject['Etapa'] = finalEtapa;
                    metadataObject['Fecha Ingreso'] = finalFechaIngreso;
                }

                Papa.parse(file, {
                    // Si es NOTAS o PAGOS, header: false. Si es DEUD/OBLI, header: true.
                    header: (groupName !== 'Pagos' && groupName !== 'Notas'),
                    skipEmptyLines: true,
                    delimiter: '|',
                    worker: true,
                    complete: (results) => {
                        let fileData = results.data;

                        if (fileData && fileData.length > 0) {
                            let dataWithMetdata = fileData;
                            let successCount = 0;

                            if (groupName === 'Pagos') {
                                // L√≥gica de Pagos (usa header: false y mapeo por √≠ndices)
                                dataWithMetdata = fileData
                                    .map(rowArray => {
                                        const id = String(rowArray[0] || '').trim();
                                        const rawDate = String(rowArray[1] || '').trim();
                                        const rawValue = String(rowArray[2] || '').trim();

                                        if (id.length === 0) return null;

                                        const cleanId = Azzorti_extractIntegerIdBeforeSpace(id);
                                        let numericValue = 0;
                                        
                                        try {
                                            const parts = String(rawValue).split('.');
                                            numericValue = parseInt(parts[0].replace(/[^0-9]/g, '')) || 0;
                                        } catch (e) {
                                            numericValue = 0;
                                        }

                                        const formattedDate = Azzorti_standardizeDate(rawDate);
                                        
                                        if (cleanId.length > 0 && numericValue > 0) {
                                             successCount++;
                                             return {
                                                [Azzorti_KEY_PAGOS]: cleanId,
                                                'Fecha Pago': formattedDate,
                                                'Valor Pago': numericValue
                                             };
                                        }
                                        return null;

                                    })
                                    .filter(row => row !== null);

                            } else if (groupName === 'Notas') {
                                // L√≥gica de Notas (usa header: false y mapeo por √≠ndices)
                                dataWithMetdata = fileData
                                    .map(rowArray => {
                                        const id = String(rowArray[0] || '').trim();
                                        const rawDate = String(rowArray[1] || '').trim();
                                        
                                        if (id.length === 0) return null;

                                        const cleanId = Azzorti_extractIntegerIdBeforeSpace(id);
                                        const formattedDate = Azzorti_standardizeDate(rawDate);

                                        if (cleanId.length > 0) {
                                             successCount++;
                                             return {
                                                [Azzorti_KEY_DEUD]: cleanId, // Usamos la misma clave para el cruce futuro
                                                'Fecha Nota': formattedDate,
                                                'ID Archivo Nota': file.name
                                             };
                                        }
                                        return null;
                                    })
                                    .filter(row => row !== null);
                            
                            } else if (groupName === 'Deud' || groupName === 'Obli') {
                                // L√≥gica de Deud y Obli (usa header: true y agrega metadatos)
                                dataWithMetdata = fileData
                                    .map(row => {
                                        // Agregar metadatos
                                        Object.assign(row, metadataObject);
                                        
                                        // Estandarizar ID para cruce
                                        const idKeyCurrent = (groupName === 'Deud') ? Azzorti_KEY_DEUD : Azzorti_KEY_OBLI;
                                        const rawId = String(row[idKeyCurrent] || '').trim();
                                        row[idKeyCurrent] = Azzorti_extractIntegerIdBeforeSpace(rawId);
                                        
                                        // Agregar Salida desde el Mapa de Cierres (solo para Deud y Obli)
                                        const keyCierre = `${row.Campanas}|${row.Corte}`;
                                        row['Salida'] = Azzorti_cierreCampanaMap.get(keyCierre) || '';

                                        if (row[idKeyCurrent]) {
                                             successCount++;
                                             return row;
                                        }
                                        return null;
                                    })
                                    .filter(row => row !== null);
                            }
                            
                            consolidatedData.push(...dataWithMetdata);
                        }

                        Azzorti_processStatus.innerHTML += ` (Rows: ${successCount.toLocaleString()})`;
                        currentFileIndex++;
                        
                        // Usamos setTimeout para evitar bloquear el hilo principal y permitir que se actualice la UI
                        setTimeout(processNextFile, 0); 
                    },
                    error: (error) => {
                        Azzorti_processStatus.innerHTML += ` ‚ùå **ERROR** en **${file.name}**: ${error.message}`;
                        currentFileIndex++;
                        setTimeout(processNextFile, 0); 
                    }
                });
            };

            processNextFile(); 
        });
    }


    /**
     * Inicia el proceso de consolidaci√≥n y cruce de datos de Azzorti.
     */
    async function Azzorti_executeConsolidation() {
        if (Azzorti_files.Deud.length === 0 || Azzorti_files.Obli.length === 0) {
            alert('Debe cargar al menos un archivo de Deudas y uno de Obligaciones.');
            return;
        }

        Azzorti_processStatus.textContent = 'Iniciando proceso de consolidaci√≥n...';
        Azzorti_processStatus.className = 'alert alert-light mt-2 py-1';
        Azzorti_processStatus.style.display = 'block';
        Azzorti_progressBarContainer.style.display = 'block';
        Azzorti_downloadButtons.style.display = 'none';

        // 1. Cargar y Consolidar
        const totalAzzortiFiles = Object.values(Azzorti_files).flat().length;
        let fileIndexOffset = 0;

        try {
            // Grupo Pagos
            Azzorti_consolidatedData.Pagos = await Azzorti_processGroup(Azzorti_files.Pagos, 'Pagos', fileIndexOffset, totalAzzortiFiles);
            fileIndexOffset += Azzorti_files.Pagos.length;

            // Grupo Deud
            Azzorti_consolidatedData.Deud = await Azzorti_processGroup(Azzorti_files.Deud, 'Deud', fileIndexOffset, totalAzzortiFiles);
            fileIndexOffset += Azzorti_files.Deud.length;

            // Grupo Obli
            Azzorti_consolidatedData.Obli = await Azzorti_processGroup(Azzorti_files.Obli, 'Obli', fileIndexOffset, totalAzzortiFiles);
            fileIndexOffset += Azzorti_files.Obli.length;

            // Grupo Notas
            Azzorti_consolidatedData.Notas = await Azzorti_processGroup(Azzorti_files.Notas, 'Notas', fileIndexOffset, totalAzzortiFiles);
            // fileIndexOffset += Azzorti_files.Notas.length; // No es necesario para el progreso final

            Azzorti_processStatus.innerHTML = '‚öôÔ∏è Iniciando Cruces de Datos...';

            // 2. Cruce Deudas vs Obligaciones (CRUCE)
            const deudasMap = new Map();
            Azzorti_consolidatedData.Deud.forEach(row => {
                const key = row[Azzorti_KEY_DEUD];
                if (!deudasMap.has(key)) {
                    deudasMap.set(key, row);
                }
            });

            Azzorti_consolidatedData.Cruze = Azzorti_consolidatedData.Obli.map(obliRow => {
                const key = obliRow[Azzorti_KEY_OBLI];
                const deudMatch = deudasMap.get(key);
                
                // Conservar todas las columnas de Obli y agregar Saldo_Deuda
                const newRow = { ...obliRow };
                
                if (deudMatch) {
                    newRow['Saldo_Deuda'] = Azzorti_extractIntegerSaldo(deudMatch['SALDO_TOTAL']);
                    newRow['Match_Deuda'] = 'SI';
                    // Conservar la fecha de ingreso m√°s antigua
                    const dateObli = Azzorti_parseDateDDMMYYYY(obliRow['Fecha Ingreso']);
                    const dateDeud = Azzorti_parseDateDDMMYYYY(deudMatch['Fecha Ingreso']);
                    if (dateDeud && (!dateObli || dateDeud < dateObli)) {
                        newRow['Fecha Ingreso'] = deudMatch['Fecha Ingreso'];
                    }
                } else {
                    newRow['Saldo_Deuda'] = 0;
                    newRow['Match_Deuda'] = 'NO';
                }

                // Calcular Saldo_Final_Obli
                const saldoTotalObli = Azzorti_extractIntegerSaldo(obliRow['SALDO TOTAL']);
                newRow['Saldo_Final_Obli'] = saldoTotalObli - newRow['Saldo_Deuda'];
                
                return newRow;
            });
            Azzorti_processStatus.innerHTML += '<br>‚úÖ Cruce D vs O (Cruze Principal) listo.';
            
            // 3. Cruce Pagos vs Cruce Principal (PagosCruze)
            const pagosMap = new Map();
            Azzorti_consolidatedData.Pagos.forEach(row => {
                const key = row[Azzorti_KEY_PAGOS];
                if (!pagosMap.has(key)) {
                    pagosMap.set(key, { 'Total Pagado': 0, 'Fecha Max Pago': '1/1/1900' });
                }
                const currentEntry = pagosMap.get(key);
                
                // Acumulaci√≥n de pagos
                currentEntry['Total Pagado'] += row['Valor Pago'];
                
                // Actualizaci√≥n de fecha m√°xima
                const currentDate = Azzorti_parseDateDDMMYYYY(row['Fecha Pago']);
                const maxDate = Azzorti_parseDateDDMMYYYY(currentEntry['Fecha Max Pago']);
                if (currentDate && currentDate > maxDate) {
                    currentEntry['Fecha Max Pago'] = row['Fecha Pago'];
                }
                
            });

            Azzorti_consolidatedData.PagosCruze = Azzorti_consolidatedData.Cruze.map(principalRow => {
                const key = principalRow[Azzorti_KEY_CRUZE_PAGOS];
                const pagoMatch = pagosMap.get(key);
                
                const newRow = { ...principalRow };
                
                newRow['Total Pagado'] = pagoMatch ? pagoMatch['Total Pagado'] : 0;
                newRow['Fecha Max Pago'] = pagoMatch ? pagoMatch['Fecha Max Pago'] : 'N/A';
                
                // Calcular Saldo_Final_Pagos
                const saldoObli = newRow['Saldo_Final_Obli'] || 0;
                newRow['Saldo_Final_Pagos'] = saldoObli - newRow['Total Pagado'];
                
                // Determinar el Validador
                const validador = (saldoObli > 0 && newRow['Total Pagado'] > 0) ? 'SI' : 'NO';
                newRow['Validador_Pagos'] = validador;
                
                // Determinar APTO (solo si Saldo_Final_Pagos > 0)
                newRow['APTO'] = (newRow['Saldo_Final_Pagos'] > 0) ? 'SI' : 'NO';
                
                return newRow;
            });
            Azzorti_processStatus.innerHTML += '<br>‚úÖ Cruce Pagos vs Principal listo.';
            
            // 4. Cruce Final (Cruze Pagos Final)
            Azzorti_consolidatedData.CruzePagosFinal = Azzorti_consolidatedData.PagosCruze.filter(row => row['APTO'] === 'SI');

            // 5. Cruce Notas vs Consolidado Final (CruzeNotasFinal)
            const finalConsolidadoMap = new Map();
            Azzorti_consolidatedData.CruzePagosFinal.forEach(row => {
                finalConsolidadoMap.set(row[Azzorti_KEY_CRUZE_PAGOS], row);
            });
            
            Azzorti_consolidatedData.CruzeNotasFinal = Azzorti_consolidatedData.Notas.map(notaRow => {
                const key = notaRow[Azzorti_KEY_DEUD];
                const finalMatch = finalConsolidadoMap.get(key);
                
                const newRow = { ...notaRow }; // Empezamos con los datos de la nota
                
                if (finalMatch) {
                    // Importar columnas del cruce principal
                    Azzorti_CRUZE_COLUMNS_TO_IMPORT.forEach(col => {
                        newRow[`Principal_${col}`] = finalMatch[col] || '';
                    });
                    newRow['Principal_Saldo_Final'] = finalMatch['Saldo_Final_Pagos'];
                    newRow['Match_Final'] = 'SI';
                } else {
                    newRow['Match_Final'] = 'NO';
                }
                
                return newRow;
            }).filter(row => row['Match_Final'] === 'SI'); // Solo se quedan las notas que matchean

            // Deduplicaci√≥n y filtro de Notas (Quedarse con la m√°s antigua y √∫nica)
            const uniqueNotesMap = new Map();
            Azzorti_consolidatedData.CruzeNotasFinal.forEach(row => {
                const id = row[Azzorti_KEY_DEUD];
                const dateNote = Azzorti_parseDateDDMMYYYY(row['Fecha Nota']);
                
                if (!uniqueNotesMap.has(id)) {
                    uniqueNotesMap.set(id, row);
                } else {
                    const existingRow = uniqueNotesMap.get(id);
                    const existingDate = Azzorti_parseDateDDMMYYYY(existingRow['Fecha Nota']);
                    
                    // Si la fecha de la nota actual es m√°s antigua, reemplaza
                    if (dateNote && existingDate && dateNote < existingDate) {
                        uniqueNotesMap.set(id, row);
                    }
                }
            });

            Azzorti_consolidatedData.CruzeNotasFinal = Array.from(uniqueNotesMap.values());
            Azzorti_processStatus.innerHTML += '<br>‚úÖ Cruce Notas vs Consolidado Final listo.';
            
            
            // 6. Reporte Final
            Azzorti_processStatus.innerHTML = `‚úÖ Proceso Finalizado. Registros en Consolidado Final: **${Azzorti_consolidatedData.CruzePagosFinal.length.toLocaleString()}**.`;
            Azzorti_processStatus.className = 'alert alert-success mt-2 py-1';
            
            // Habilitar todos los botones de descarga
            const allDownloadButtons = document.querySelectorAll('#azzortiDownloadButtons button');
            allDownloadButtons.forEach(btn => btn.disabled = false);
            Azzorti_downloadButtons.style.display = 'flex';
            
            Azzorti_progressBarContainer.style.display = 'none';

        } catch (e) {
            Azzorti_processStatus.innerHTML = `‚ùå **ERROR CR√çTICO** durante la consolidaci√≥n o cruce: ${e.message}`;
            Azzorti_processStatus.className = 'alert alert-danger mt-2 py-1';
            Azzorti_progressBarContainer.style.display = 'none';
            console.error(e);
        }
    }


    /**
     * Controlador principal de carga de carpeta de Azzorti.
     */
    async function Azzorti_processFileHandler(event) {
        Azzorti_files = { 'Notas': [], 'Pagos': [], 'Deud': [], 'Obli': [] };
        Azzorti_cierreCampanaMap.clear();

        Azzorti_status.textContent = 'Clasificando archivos...';
        Azzorti_status.className = 'alert alert-info py-1';
        Azzorti_downloadButtons.style.display = 'none';
        
        const files = Array.from(event.target.files).filter(file => file.size > 0);
        let cierreCsvFile = null;

        for (const file of files) {
            if (file.name.toLowerCase() === 'cierres.csv') {
                cierreCsvFile = file;
            } else if (file.name.toLowerCase().endsWith('.txt') || file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.dat')) {
                Azzorti_classifyFile(file);
            }
        }
        
        Azzorti_updateCounts();
        Azzorti_loadCierreCampanaFile(cierreCsvFile); // Cargar Cierres de Campa√±a

        const totalFiles = Object.values(Azzorti_files).flat().length;

        if (Azzorti_files.Deud.length > 0 && Azzorti_files.Obli.length > 0 && totalFiles > 0) {
            Azzorti_status.textContent = `Clasificaci√≥n finalizada. Archivos listos para procesar: ${totalFiles} en total. Iniciando Consolidaci√≥n Autom√°tica...`;
            Azzorti_status.className = 'alert alert-success py-1';
            await Azzorti_executeConsolidation();
        } else {
            Azzorti_status.textContent = '‚ö†Ô∏è Clasificaci√≥n finalizada. Aseg√∫rese de cargar archivos en las carpetas de Deudas, Obligaciones y Cierres.csv.';
            Azzorti_status.className = 'alert alert-warning py-1';
        }
    }

    // --- EVENT LISTENERS AZZORTI ---
    document.addEventListener('DOMContentLoaded', () => {
        Azzorti_folderInput.addEventListener('change', Azzorti_processFileHandler);
    });
    
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
