<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROCESOS YESBPO | M√≥dulos Unificados (Comfama y Azzorti)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { background-color: #f4f7f6; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1400px; margin-top: 20px; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); flex-grow: 1; }
        .section-panel { padding: 15px; border: 1px solid #e0e0e0; border-radius: 0.25rem; margin-bottom: 20px; }
        .step-divider { border-top: 4px solid #0d6efd; margin-top: 30px; margin-bottom: 30px; padding-top: 15px; }
        h1 { color: #0d6efd; font-weight: 700; margin-bottom: 30px; }
        .section-title { font-size: 1.5rem; color: #495057; border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 20px; }
        .module-nav button { transition: all 0.3s ease; font-weight: 600; font-size: 1.1rem; border-radius: 0.5rem; border: 2px solid #0d6efd; background-color: #ffffff; color: #0d6efd; }
        .module-nav button.active { background-color: #0d6efd; color: #ffffff; box-shadow: 0 4px 8px rgba(13, 110, 253, 0.5); }
        .module-nav button:hover:not(.active) { background-color: #e9f0ff; color: #0b5ed7; }
        .hidden-preview { display: none !important; }
        .hidden-filters select, .hidden-filters button { display: none !important; } 
        .footer { padding: 15px 0; background-color: #e9ecef; color: #6c757d; text-align: center; margin-top: 20px; font-size: 0.85rem; }
    </style>
</head>
<body onload="loadCacheOnStart()">

<div class="container">
    <h1 class="text-center">PROCESOS YESBPO | M√≥dulos Integrados</h1>
    
    <div class="d-flex flex-wrap justify-content-center gap-3 mb-4 module-nav" role="tablist">
        <button class="btn px-4 py-2 active" id="comfama-tab" data-bs-toggle="tab" data-bs-target="#comfama" type="button" role="tab" aria-controls="comfama" aria-selected="true">
            Comfama Financiera üè¶
        </button>
        <button class="btn px-4 py-2" id="azzorti-tab" data-bs-toggle="tab" data-bs-target="#azzorti" type="button" role="tab" aria-controls="azzorti" aria-selected="false">
            Azzorti üëï
        </button>
        <button class="btn px-4 py-2" id="otra-tab" data-bs-toggle="tab" data-bs-target="#otra" type="button" role="tab" aria-controls="otra" aria-selected="false">
            Otro M√≥dulo ‚ú®
        </button>
    </div>

    <div class="tab-content" id="processTabsContent">
        
        <div class="tab-pane fade show active" id="comfama" role="tabpanel" aria-labelledby="comfama-tab">
            <div class="alert alert-warning py-2 mb-4" id="cacheStatus" style="display:none;"></div>

            <div id="pagosSection" class="section-panel">
                <div class="section-title text-success">1. Carpeta de Pagos (Consolidaci√≥n y Cach√©)</div>
                
                <p class="fw-bold">1.1 Carga de Carpeta de Pagos</p>
                <input type="file" webkitdirectory directory multiple class="form-control mb-3" id="pagosFolderInput">
                <div class="alert alert-info py-1" id="pagosStatus">Cargue la **Carpeta de Pagos** para Consolidaci√≥n. *Este paso debe finalizar antes del Paso 2.*</div>
                
                <div class="alert alert-light mt-2 py-1" id="pagosProcessStatus" style="display:none;"></div>
                
                <div class="progress mb-2" id="pagosProgressBarContainer" style="height: 25px; display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="pagosProgressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
            </div>
            
            <div class="section-panel step-divider">
                <div class="section-title">2. Carpeta de Asignaciones (Limpieza y Cruce)</div>
                
                <p class="fw-bold">2.1 Carga de Carpeta de Asignaciones (Principal)</p>
                <input type="file" webkitdirectory directory multiple class="form-control mb-3" id="folderInput" disabled>
                <div class="alert alert-info py-1" id="anexoStatus">Espere a que el Paso 1 finalice para cargar aqu√≠.</div>
                
                <p class="fw-bold mt-4">2.2 Proceso Autom√°tico (Limpieza y Cruce)</p>
                
                <div class="alert alert-light mt-2 py-1" id="dedupeStatus" style="display:none;"></div>

                <div class="progress mb-2" id="asignacionesProgressBarContainer" style="height: 25px; display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" id="asignacionesProgressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
                    <button class="btn btn-primary btn-lg" onclick="downloadFile(mergedData, 'resultado_cruce_final.csv', '|');" id="downloadMergeBtn" style="display:none;">
                        Descargar Data
                    </button>
                    <button id="downloadAnexoBtn" style="display:none;"></button>
                </div>
                
            </div>
        </div>

        <div class="tab-pane fade" id="azzorti" role="tabpanel" aria-labelledby="azzorti-tab">
            <div class="section-panel">
                <div class="section-title text-primary">1. Carga, Clasificaci√≥n y Procesamiento Autom√°tico</div> <p class="fw-bold">1.1 Carga de Carpeta Principal (Incluye subcarpetas)</p>
                <input type="file" webkitdirectory directory multiple class="form-control mb-3" id="azzortiFolderInput">
                <div class="alert alert-info py-1" id="azzortiStatus">Cargue la **Carpeta Principal** de Azzorti. Se buscar√°n archivos TXT y el CSV llamado **CIERRES.csv**. El proceso iniciar√° autom√°ticamente.</div> <p class="fw-bold mt-4">1.2 Resultados de la Clasificaci√≥n</p>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiNotesCount">Notas: 0 archivos</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiPagosCount">Pagos: 0 archivos</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiDeudCount">Deudas: 0 archivos</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-light py-1" id="azzortiObliCount">Obligaciones: 0 archivos</div>
                    </div>
                    <div class="col-12 mb-2">
                        <div class="alert alert-warning py-1" id="cierreCampanaStatus">CSV Cierres: Pendiente de b√∫squeda en la carpeta.</div>
                    </div>
                </div>
            </div>

            <div class="section-panel step-divider">
                <div class="section-title text-success">2. Consolidaci√≥n, Cruce y Descargas</div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3" style="display:none;"> <button class="btn btn-success btn-lg" onclick="executeAzzortiConsolidation();" id="azzortiProcessBtn" disabled>
                        Iniciar Consolidaci√≥n de Datos
                    </button>
                </div>

                <div class="alert alert-light mt-2 py-1" id="azzortiProcessStatus" style="display:none;"></div>

                <div class="progress mb-2" id="azzortiProgressBarContainer" style="height: 25px; display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" id="azzortiProgressBar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                
                <div class="mt-4 row g-3" id="azzortiDownloadButtons" style="display:none;">
                    <p class="fw-bold">Descarga de Archivos Consolidado:</p>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadNotasBtn" onclick="downloadFile(azzortiConsolidatedData.Notas, 'Azzorti_Notas_Consolidado.csv', '|')" disabled>Notas</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadPagosBtn" onclick="downloadFile(azzortiConsolidatedData.Pagos, 'Azzorti_Pagos_Consolidado.csv', '|')" disabled>Pagos (Limpio)</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadDeudBtn" onclick="downloadFile(azzortiConsolidatedData.Deud, 'Azzorti_Deud_Consolidado.csv', '|')" disabled>Deudas</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-info" id="downloadObliBtn" onclick="downloadFile(azzortiConsolidatedData.Obli, 'Azzorti_Obli_Consolidado.csv', '|')" disabled>Obligaciones</button>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="col-12 d-flex flex-wrap gap-2">
                        <button class="btn btn-danger btn-lg" id="downloadCruzeBtn" onclick="downloadFile(azzortiConsolidatedData.Cruze, 'Azzorti_Cruze_Deudas_Obligaciones.csv', '|')" disabled>
                            Descargar **CRUCE** Deudas vs. Obligaciones
                        </button>
                        
                        <button class="btn btn-primary btn-lg" id="downloadPagosCruzeBtn" onclick="downloadFile(azzortiConsolidatedData.PagosCruze, 'Azzorti_Cruze_Pagos_Principal_AGREGADO.csv', '|')" disabled>
                            Descargar **CRUCE** Pagos vs. Principal
                        </button>
                        
                        <button class="btn btn-warning btn-lg" id="downloadCruzePagosFinalBtn" onclick="downloadFile(azzortiConsolidatedData.CruzePagosFinal, 'Azzorti_CONSOLIDADO_FINAL.csv', '|')" disabled>
                            Descargar **CONSOLIDADO FINAL**
                        </button>
                        
                        <button class="btn btn-info btn-lg" id="downloadCruzeNotasFinalBtn" onclick="downloadFile(azzortiConsolidatedData.CruzeNotasFinal, 'Azzorti_CRUCE_NOTAS_CONSOLIDADO.csv', '|')" disabled>
                            Descargar **CRUCE NOTAS** vs. Consolidado
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div class="tab-pane fade" id="otra" role="tabpanel" aria-labelledby="otra-tab">
            <div class="alert alert-secondary text-center py-4">
                <h4>Otro M√≥dulo (En Construcci√≥n)</h4>
                <p>Este espacio est√° reservado para futuros procesos de automatizaci√≥n.</p>
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    Autor√≠a: Andr√©s Vanegas - √Årea de Inteligencia YesBPO
</footer>

<script>
    // ======================================================================
    // === C√ìDIGO UNIFICADO Y RENOMBRADO ===
    // ======================================================================

    // ----------------------------------------------------------------------
    // --- VARIABLES GLOBALES (Comfama - Sin Renombrar UI/Data) ---
    // ----------------------------------------------------------------------
    let db;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Comfama IndexedDB instance
    const CACHE_KEY_PAGOS = 'processedPagosData';

    let dataFilePagos = null;¬† ¬† // Comfama: Data consolidada de Pagos
    let processedDataAsignaciones = null;¬† // Comfama: Data de Asignaciones procesada
    let mergedData = null;¬† ¬† ¬† ¬† // Comfama: Data final cruce

    // Referencias de UI (Comfama)
    const folderInput = document.getElementById('folderInput'); // Asignaciones input
    const anexoStatus = document.getElementById('anexoStatus');
    const dedupeStatus = document.getElementById('dedupeStatus');
    const downloadMergeBtn = document.getElementById('downloadMergeBtn');
    const pagosFolderInput = document.getElementById('pagosFolderInput');
    const pagosStatus = document.getElementById('pagosStatus');
    const pagosProcessStatus = document.getElementById('pagosProcessStatus');
    
    const pagosProgressBar = document.getElementById('pagosProgressBar');
    const pagosProgressBarContainer = document.getElementById('pagosProgressBarContainer');
    const asignacionesProgressBar = document.getElementById('asignacionesProgressBar');
    const asignacionesProgressBarContainer = document.getElementById('asignacionesProgressBarContainer');
    
    let totalRowsCount = 0; 
    let processedRowsCount = 0; 
    
    // Nombres de Columnas (Comfama CONSTANTES)
    const COL_DOC_PRIN = 'Numero Documento';
    const COL_MES_PRIN = 'Mes data';
    const COL_FECHA_PRIN = 'Nombre del archivo'; 
    const COL_ANIO_PRIN = 'A√±o';
    const COL_DOC_PAGOS = 'Numero de Documento';
    const COL_MES_PAGOS = 'MES';
    const COL_FECHA_MAX_PAGOS = 'Fecha_Movimiento_Maxima';
    const COL_VALOR_PAGADO = 'Suma_Valor_Pagado';
    const COL_VALOR_PAGADO_RAW = 'Valor Pagado';¬†
    const COL_FECHA_MOV = 'Fecha Movimiento';¬†

    // ----------------------------------------------------------------------
    // --- VARIABLES GLOBALES (Azzorti) ---
    // ----------------------------------------------------------------------
    const azzortiFolderInput = document.getElementById('azzortiFolderInput');
    const azzortiStatus = document.getElementById('azzortiStatus');
    const azzortiProcessBtn = document.getElementById('azzortiProcessBtn');
    const azzortiProcessStatus = document.getElementById('azzortiProcessStatus');
    const azzortiProgressBar = document.getElementById('azzortiProgressBar');
    const azzortiProgressBarContainer = document.getElementById('azzortiProgressBarContainer');
    const azzortiDownloadButtons = document.getElementById('azzortiDownloadButtons');
    const downloadCruzeBtn = document.getElementById('downloadCruzeBtn');
    const downloadPagosCruzeBtn = document.getElementById('downloadPagosCruzeBtn'); 
    const downloadCruzePagosFinalBtn = document.getElementById('downloadCruzePagosFinalBtn');
    const downloadCruzeNotasFinalBtn = document.getElementById('downloadCruzeNotasFinalBtn'); 
    const cierreCampanaStatus = document.getElementById('cierreCampanaStatus');

    // Claves de identificaci√≥n para el cruce (Azzorti)
    const AZZORTI_KEY_DEUD = 'NUMERO IDENTIFICACION'; 
    const AZZORTI_KEY_OBLI = 'NUM. IDENTIFICACION'; 
    const AZZORTI_KEY_PAGOS = 'NUM. IDENTIFICACION'; 
    const AZZORTI_KEY_CRUZE_PAGOS = 'NUMERO IDENTIFICACION'; 
    
    let azzortiFiles = {
        'Notas': [],
        'Pagos': [],
        'Deud': [],
        'Obli': []
    };
    
    let azzortiConsolidatedData = {
        'Notas': null,
        'Pagos': null,
        'Deud': null,
        'Obli': null,
        'Cruze': null, 
        'PagosCruze': null, 
        'CruzePagosFinal': null, 
        'CruzeNotasFinal': null 
    };
    
    let cierreCampanaMap = new Map(); 
    
    const COLUMNS_TO_DELETE = [
        'Part_0', 'Part_1', 'Part_2', 'Part_3', 'Part_4', '_1', '_2', '_3'
    ];
    
    const RENAME_MAP = {
        'Part_5': 'Campanas', 
        'Part_6': 'Corte',
        'Part_7': 'Fecha Ingreso'
    };
    
    const CRUZE_COLUMNS_TO_IMPORT = [
        'Campanas', 
        'Fecha Ingreso',
        'Etapa', 
        'Salida'
    ];

    // ----------------------------------------------------------------------
    // --- UTILIDADES GLOBALES ---
    // ----------------------------------------------------------------------

    /**
     * Helper para descargar archivos. Usado por ambos m√≥dulos.
     */
    function downloadFile(data, filename, delimiter = ',') {
        if (!data) {
            alert("No hay datos para descargar. Ejecute el proceso primero.");
            return;
        }

        const csv = Papa.unparse(data, {
            delimiter: delimiter,
            header: true 
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    /**
     * Actualiza la barra de progreso. Usado por ambos m√≥dulos.
     */
    function updateProgressBar(progressBarId, progressContainerId, percentage, statusMessage, isFinished = false, isError = false) {
        const progressBar = document.getElementById(progressBarId);
        const progressContainer = document.getElementById(progressContainerId);
        if (progressContainer) progressContainer.style.display = percentage > 0 ? 'flex' : 'none';

        if (progressBar) {
            progressBar.style.width = percentage.toFixed(2) + '%';
            progressBar.textContent = percentage.toFixed(2) + '%';
            
            progressBar.classList.remove('bg-danger', 'bg-success', 'bg-primary', 'progress-bar-animated', 'progress-bar-striped');

            if (isError) {
                progressBar.classList.add('bg-danger');
            } else if (progressBarId.includes('azzorti')) {
                progressBar.classList.add('bg-primary'); 
            } else if (progressBarId.includes('asignaciones')) {
                progressBar.classList.add('bg-success'); 
            } else {
                progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
            }
            
            if (isFinished && !isError) {
                progressBar.classList.add('bg-success');
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.textContent = '100% - Completo';
            }
        }

        const statusElementId = (progressBarId.includes('pagos')) ? 'pagosProcessStatus' : (progressBarId.includes('asignaciones')) ? 'dedupeStatus' : 'azzortiProcessStatus';
        const statusElement = document.getElementById(statusElementId);
        if (statusElement) {
            statusElement.style.display = 'block';
            statusElement.textContent = statusMessage;
            statusElement.className = isError ? 'alert alert-danger py-1' : 'alert alert-light mt-2 py-1';
        }
    }

    /**
     * Determina el delimitador de un archivo. Usado por Comfama.
     */
    function determineDelimiter(fileChunk) {
        if (fileChunk.includes('|')) return '|';
        if (fileChunk.includes(';')) return ';';
        if (fileChunk.includes(',')) return ',';
        return ','; 
    }
    
    /**
     * Limpia un n√∫mero de documento (solo d√≠gitos). Usado por Comfama.
     */
    function cleanNumeroDocumentoComfama(doc) {
        if (!doc) return '';
        return String(doc).replace(/\D/g, '').trim();
    }

    // ----------------------------------------------------------------------
    // --- L√ìGICA COMFAMA (IndexedDB y Cache) ---
    // ----------------------------------------------------------------------
    
    function initDB() { 
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) { 
                console.warn('IndexedDB no soportado. Cach√© deshabilitado.'); 
                document.getElementById('cacheStatus').style.display = 'block';
                document.getElementById('cacheStatus').textContent = '‚ö†Ô∏è Advertencia: IndexedDB no es compatible con su navegador. La funcionalidad de cach√© no estar√° disponible.';
                return resolve(null); 
            }
            const request = window.indexedDB.open("ComfamaCacheDB", 1);
            request.onerror = (event) => { console.error(`Error al abrir la base de datos: ${event.target.errorCode}`, event.target.error); reject(event.target.error); };
            request.onsuccess = (event) => { db = event.target.result; resolve(db); };
            request.onupgradeneeded = (event) => {
                const dbInstance = event.target.result;
                if (!dbInstance.objectStoreNames.contains('dataStore')) { dbInstance.createObjectStore('dataStore', { keyPath: 'key' }); }
            };
        });
    }

    function saveDataToCache(key, data) {
        if (!db) return Promise.resolve();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['dataStore'], 'readwrite');
            const store = transaction.objectStore('dataStore');
            const dataToStore = { key: key, data: data, timestamp: new Date() };
            const request = store.put(dataToStore);
            request.onsuccess = () => resolve();
            request.onerror = (event) => { console.error('Error al guardar en cach√©.', event.target.error); reject(event.target.error); };
        });
    }

    function loadDataFromCache(key) {
        if (!db) return Promise.resolve(null);
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['dataStore'], 'readonly');
            const store = transaction.objectStore('dataStore');
            const request = store.get(key);
            request.onsuccess = () => {
                const result = request.result;
                const cacheStatusEl = document.getElementById('cacheStatus');
                if (result && result.data && result.data.length > 0) {
                    dataFilePagos = result.data;
                    cacheStatusEl.style.display = 'block';
                    cacheStatusEl.textContent = `‚úÖ Data de Pagos (Cach√©) cargada. Filas: ${dataFilePagos.length.toLocaleString()}. Lista para usar.`;
                    cacheStatusEl.className = 'alert alert-success py-1';
                    folderInput.disabled = false;
                    resolve(dataFilePagos);
                } else {
                    cacheStatusEl.style.display = 'block';
                    cacheStatusEl.textContent = '‚ÑπÔ∏è Data de Pagos no encontrada en cach√©. Cargue la Carpeta de Pagos (Paso 1).';
                    cacheStatusEl.className = 'alert alert-info py-1';
                    folderInput.disabled = true;
                    resolve(null);
                }
            };
            request.onerror = (event) => { 
                console.error('Error al cargar el cach√©.', event.target.error); 
                document.getElementById('cacheStatus').style.display = 'block';
                document.getElementById('cacheStatus').textContent = '‚ùå Error al cargar el cach√© de Pagos. Pruebe a recargar la p√°gina.';
                document.getElementById('cacheStatus').className = 'alert alert-danger py-1';
                resolve(null); 
            };
        });
    }

    async function loadCacheOnStart() {
        try {
            await initDB();
            await loadDataFromCache(CACHE_KEY_PAGOS);
        } catch (e) {
            console.error('Fallo grave al inicializar la base de datos de cach√©.', e);
        }
    }


    // ----------------------------------------------------------------------
    // --- L√ìGICA COMFAMA (Procesamiento) - RENOMBRADO ---
    // ----------------------------------------------------------------------

    /**
     * Procesa un √∫nico archivo de Pagos, agregando la data.
     * @param {File} file El objeto File.
     */
    function processComfamaPagosFile(file, fileIndex, totalFiles) {
        return new Promise((resolve, reject) => {
            let processedRows = 0;
            const reader = new FileReader();

            reader.onload = (event) => {
                const chunk = event.target.result.substring(0, 1024 * 10); 
                const delimiter = determineDelimiter(chunk);
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: delimiter,
                    worker: true,
                    complete: (results) => {
                        const data = results.data;
                        const errors = results.errors;

                        if (errors.length > 0) {
                            console.error(`Errores en el archivo ${file.name}:`, errors);
                        }

                        if (data.length > 0) {
                            const originalDocKey = results.meta.fields.find(field => cleanStringAzzorti(field).includes(cleanStringAzzorti(COL_DOC_PAGOS)));
                            const originalMesKey = results.meta.fields.find(field => cleanStringAzzorti(field).includes(cleanStringAzzorti(COL_MES_PAGOS)));
                            const originalFechaMovKey = results.meta.fields.find(field => cleanStringAzzorti(field).includes(cleanStringAzzorti(COL_FECHA_MOV)));
                            const originalValorPagadoKey = results.meta.fields.find(field => cleanStringAzzorti(field).includes(cleanStringAzzorti(COL_VALOR_PAGADO_RAW)) && !cleanStringAzzorti(field).includes('suma'));

                            if (!originalDocKey || !originalMesKey || !originalFechaMovKey || !originalValorPagadoKey) {
                                pagosProcessStatus.textContent = `‚ùå Error en ${file.name}: Faltan columnas clave (Documento, Mes, Fecha Movimiento, Valor Pagado).`;
                                resolve({ success: false, rows: 0 });
                                return;
                            }
                            
                            data.forEach(row => {
                                const doc = cleanNumeroDocumentoComfama(row[originalDocKey]);
                                const mes = String(row[originalMesKey] || '').trim();
                                const fechaMov = String(row[originalFechaMovKey] || '').trim();
                                let valorPagado = parseFloat(String(row[originalValorPagadoKey] || 0).replace(/[$.]/g, '').replace(',', '.')); 
                                
                                if (isNaN(valorPagado)) valorPagado = 0;
                                
                                if (doc && mes && fechaMov && valorPagado > 0) {
                                    const key = `${doc}|${mes}`;
                                    
                                    // Guardamos la fila completa, si ya existe, actualizamos los campos clave
                                    if (dataFilePagos.find(r => `${cleanNumeroDocumentoComfama(r[originalDocKey])}|${String(r[originalMesKey] || '').trim()}` === key)) {
                                        // Si ya existe, actualizamos la fecha y sumamos el valor
                                        const existingRow = dataFilePagos.find(r => `${cleanNumeroDocumentoComfama(r[originalDocKey])}|${String(r[originalMesKey] || '').trim()}` === key);
                                        
                                        // Conversi√≥n de fechas para comparaci√≥n
                                        const existingDate = new Date(existingRow[COL_FECHA_MOV]);
                                        const newDate = new Date(fechaMov);
                                        
                                        if (newDate > existingDate) {
                                            existingRow[COL_FECHA_MOV] = fechaMov;
                                        }
                                        
                                        // Sumamos el valor
                                        existingRow[COL_VALOR_PAGADO] = (existingRow[COL_VALOR_PAGADO] || 0) + valorPagado;
                                    } else {
                                        // Si es nueva, la agregamos
                                        const newRow = { ...row };
                                        newRow[COL_DOC_PAGOS] = doc; // Estandarizamos el documento
                                        newRow[COL_VALOR_PAGADO] = valorPagado; // Creamos la columna agregada
                                        newRow[COL_FECHA_MOV] = fechaMov; // Aseguramos la columna de fecha
                                        dataFilePagos.push(newRow);
                                    }
                                    processedRows++;
                                }
                            });
                        }

                        const percentage = ((fileIndex + 1) / totalFiles) * 100;
                        updateProgressBar('pagosProgressBar', 'pagosProgressBarContainer', percentage, `‚úÖ Procesado **${file.name}**. Filas v√°lidas: ${processedRows.toLocaleString()}.`);
                        resolve({ success: true, rows: processedRows });

                    },
                    error: (error) => {
                        console.error(`Error al parsear ${file.name}:`, error);
                        reject(error);
                    }
                });
            };

            reader.onerror = (error) => {
                console.error(`Error al leer ${file.name}:`, error);
                reject(error);
            };

            reader.readAsText(file);
        });
    }

    /**
     * Inicia el proceso de consolidaci√≥n de Pagos (Comfama).
     */
    async function executeComfamaPagosProcess(files) {
        dataFilePagos = dataFilePagos || [];
        totalRowsCount = 0;
        processedRowsCount = 0;
        
        pagosStatus.className = 'alert alert-warning py-1';
        pagosStatus.textContent = `‚öôÔ∏è Iniciando consolidaci√≥n de ${files.length} archivos de Pagos...`;
        pagosProcessStatus.style.display = 'block';
        updateProgressBar('pagosProgressBar', 'pagosProgressBarContainer', 0, 'Iniciando proceso...');

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const result = await processComfamaPagosFile(file, i, files.length);
                totalRowsCount += result.rows;
            }

            if (dataFilePagos.length > 0) {
                await saveDataToCache(CACHE_KEY_PAGOS, dataFilePagos);
                pagosStatus.textContent = `‚úÖ Consolidaci√≥n de Pagos y Cach√© completados. Total de registros consolidados: ${dataFilePagos.length.toLocaleString()}.`;
                pagosStatus.className = 'alert alert-success py-1';
                folderInput.disabled = false;
            } else {
                pagosStatus.textContent = '‚ö†Ô∏è Consolidaci√≥n completada, pero no se encontraron registros v√°lidos.';
                pagosStatus.className = 'alert alert-warning py-1';
                folderInput.disabled = true;
            }
            updateProgressBar('pagosProgressBar', 'pagosProgressBarContainer', 100, 'Consolidaci√≥n de Pagos Finalizada.', true);
        } catch (error) {
            console.error("Error en el proceso de Pagos:", error);
            pagosStatus.textContent = '‚ùå Error grave durante el proceso de Pagos. Revise la consola.';
            pagosStatus.className = 'alert alert-danger py-1';
            updateProgressBar('pagosProgressBar', 'pagosProgressBarContainer', 100, 'Error en el Proceso de Pagos.', true, true);
            folderInput.disabled = true;
        }
    }

    /**
     * Procesa un √∫nico archivo de Asignaciones (Comfama), cruza con pagos y realiza deduplicaci√≥n.
     */
    function processComfamaAsignacionesFile(file, fileIndex, totalFiles) {
        return new Promise((resolve, reject) => {
            let processedRows = 0;
            const pagosMap = new Map();
            dataFilePagos.forEach(row => {
                const key = cleanNumeroDocumentoComfama(row[COL_DOC_PAGOS]) + '|' + String(row[COL_MES_PAGOS] || '').trim();
                pagosMap.set(key, row);
            });

            const reader = new FileReader();

            reader.onload = (event) => {
                const chunk = event.target.result.substring(0, 1024 * 10); 
                const delimiter = determineDelimiter(chunk);
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: delimiter,
                    worker: true,
                    complete: (results) => {
                        let data = results.data;
                        const errors = results.errors;

                        if (errors.length > 0) {
                            console.error(`Errores en el archivo ${file.name}:`, errors);
                        }
                        
                        // Encontrando las columnas clave
                        const originalDocKey = results.meta.fields.find(field => cleanStringAzzorti(field).includes(cleanStringAzzorti(COL_DOC_PRIN)));
                        const originalMesKey = results.meta.fields.find(field => cleanStringAzzorti(field).includes(cleanStringAzzorti(COL_MES_PRIN)));
                        const originalAnioKey = results.meta.fields.find(field => cleanStringAzzorti(field).includes(cleanStringAzzorti(COL_ANIO_PRIN)));

                        if (!originalDocKey || !originalMesKey || !originalAnioKey) {
                            dedupeStatus.textContent = `‚ùå Error en ${file.name}: Faltan columnas clave (Documento, Mes data, A√±o).`;
                            resolve({ success: false, rows: 0 });
                            return;
                        }

                        if (data.length > 0) {
                            data = data.map(row => {
                                const doc = cleanNumeroDocumentoComfama(row[originalDocKey]);
                                const mes = String(row[originalMesKey] || '').trim();
                                const anio = String(row[originalAnioKey] || '').trim();
                                const pagosKey = `${doc}|${mes}`;
                                const pagosRow = pagosMap.get(pagosKey);
                                
                                if (pagosRow) {
                                    row['Estado_Cruce_Pagos'] = 'CRUZADO';
                                    row[COL_FECHA_MAX_PAGOS] = pagosRow[COL_FECHA_MOV];
                                    row[COL_VALOR_PAGADO] = pagosRow[COL_VALOR_PAGADO];
                                } else {
                                    row['Estado_Cruce_Pagos'] = 'PENDIENTE';
                                    row[COL_FECHA_MAX_PAGOS] = '';
                                    row[COL_VALOR_PAGADO] = 0;
                                }

                                row[COL_DOC_PRIN] = doc; // Estandarizamos el documento
                                row[COL_FECHA_PRIN] = file.name; // Agregamos nombre de archivo
                                
                                processedRows++;
                                return row;
                            }).filter(row => row[originalDocKey] && row[originalMesKey]); 
                            
                            processedDataAsignaciones.push(...data);
                        }

                        const percentage = ((fileIndex + 1) / totalFiles) * 100;
                        updateProgressBar('asignacionesProgressBar', 'asignacionesProgressBarContainer', percentage, `‚úÖ Procesado **${file.name}**. Registros: ${data.length.toLocaleString()}.`);
                        resolve({ success: true, rows: data.length });

                    },
                    error: (error) => {
                        console.error(`Error al parsear ${file.name}:`, error);
                        reject(error);
                    }
                });
            };

            reader.onerror = (error) => {
                console.error(`Error al leer ${file.name}:`, error);
                reject(error);
            };

            reader.readAsText(file);
        });
    }

    /**
     * Inicia el proceso de Asignaciones (Comfama), deduplicaci√≥n y llama a la fusi√≥n final.
     */
    async function executeComfamaAsignacionesPreProcess(files) {
        processedDataAsignaciones = [];
        mergedData = null;
        
        anexoStatus.className = 'alert alert-warning py-1';
        anexoStatus.textContent = `‚öôÔ∏è Iniciando procesamiento de ${files.length} archivos de Asignaciones...`;
        dedupeStatus.style.display = 'block';
        updateProgressBar('asignacionesProgressBar', 'asignacionesProgressBarContainer', 0, 'Iniciando proceso de cruce...');

        try {
            for (let i = 0; i < files.length; i++) {
                await processComfamaAsignacionesFile(files[i], i, files.length);
            }
            
            updateProgressBar('asignacionesProgressBar', 'asignacionesProgressBarContainer', 100, 'Procesamiento de Asignaciones Finalizado. Iniciando Cruce Final...', true);
            
            // L√≥gica de Deduplicaci√≥n y Merging
            await executeComfamaMerge();
            
        } catch (error) {
            console.error("Error en el proceso de Asignaciones:", error);
            anexoStatus.textContent = '‚ùå Error grave durante el proceso de Asignaciones. Revise la consola.';
            anexoStatus.className = 'alert alert-danger py-1';
            updateProgressBar('asignacionesProgressBar', 'asignacionesProgressBarContainer', 100, 'Error en el Proceso de Asignaciones.', true, true);
        }
    }

    /**
     * Realiza el cruce final y deduplicaci√≥n de Asignaciones (Comfama).
     */
    async function executeComfamaMerge() {
        if (!processedDataAsignaciones || processedDataAsignaciones.length === 0) {
            dedupeStatus.textContent = '‚ö†Ô∏è No hay datos de Asignaciones para consolidar.';
            dedupeStatus.className = 'alert alert-warning py-1';
            downloadMergeBtn.style.display = 'none';
            return;
        }

        dedupeStatus.textContent = `‚öôÔ∏è Realizando deduplicaci√≥n en ${processedDataAsignaciones.length.toLocaleString()} registros...`;
        
        const uniqueKeys = new Set();
        const finalData = [];
        
        // Deduplicaci√≥n por Documento + Mes data + A√±o
        processedDataAsignaciones.forEach(row => {
            const doc = cleanNumeroDocumentoComfama(row[COL_DOC_PRIN]);
            const mes = String(row[COL_MES_PRIN] || '').trim();
            const anio = String(row[COL_ANIO_PRIN] || '').trim();
            const key = `${doc}|${mes}|${anio}`;
            
            if (!uniqueKeys.has(key)) {
                uniqueKeys.add(key);
                finalData.push(row);
            }
        });
        
        mergedData = finalData;

        dedupeStatus.textContent = `‚úÖ Cruce y Deduplicaci√≥n Finalizados. Registros √önicos: ${finalData.length.toLocaleString()}.`;
        dedupeStatus.className = 'alert alert-success py-1';
        anexoStatus.textContent = `‚úÖ Proceso Completado. Registros listos para descarga.`;
        anexoStatus.className = 'alert alert-success py-1';
        downloadMergeBtn.style.display = 'inline-block';
    }

    // ----------------------------------------------------------------------
    // --- L√ìGICA AZZORTI (Extracci√≥n, Limpieza y Cruces) ---
    // ----------------------------------------------------------------------

    /**
     * Limpia una cadena (elimina acentos, √±, caracteres especiales y espacios).
     * RENOMBRADA a cleanStringAzzorti para evitar conflictos.
     */
    function cleanStringAzzorti(str) {
        if (!str) return '';
        let cleaned = String(str).replace(/[\r\n]/g, '').trim();
        cleaned = cleaned.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        cleaned = cleaned.replace(/[^a-z0-9]/gi, ''); 
        return cleaned.toLowerCase();
    }
    
    // ... (El resto de funciones de Azzorti se mantienen sin cambios o con referencias internas actualizadas a cleanStringAzzorti) ...
    // NOTA: Para mantener el c√≥digo manejable, se asume que las funciones internas de Azzorti ya usan cleanStringAzzorti.

    /**
     * Estandariza la fecha de Azzorti de MM/DD/YYYY o MM-DD-YYYY a DD/MM/YYYY.
     * @param {string} dateStr La cadena de fecha a estandarizar.
     * @returns {string} La fecha en formato DD/MM/YYYY o la cadena original si es inv√°lida.
     */
    function standardizeDateAzzorti(dateStr) {
        if (!dateStr) return '';
        let cleanedStr = String(dateStr).trim().replace(/[ \/\-]/g, '/'); 
        const parts = cleanedStr.split('/');
        
        if (parts.length === 3) {
            const month = parts[0].padStart(2, '0');
            const day = parts[1].padStart(2, '0');
            let year = parts[2];
            
            if (year.length === 2) {
                year = `20${year}`;
            }
            return `${day}/${month}/${year}`;
        }
        return cleanedStr;
    }

    /**
     * Convierte una fecha en formato DD/MM/YYYY a un objeto Date para comparaci√≥n.
     */
    function parseDateForValidation(dateStr) {
        if (!dateStr) return null;

        const parts = String(dateStr).split('/');
        if (parts.length !== 3) return null;

        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);

        if (isNaN(day) || isNaN(month) || isNaN(year)) return null;

        const date = new Date(Date.UTC(year, month - 1, day)); 
        
        if (date.getUTCFullYear() !== year || date.getUTCMonth() !== month - 1 || date.getUTCDate() !== day) {
            return null;
        }

        return date;
    }

    /**
     * NUEVA FUNCI√ìN: Convierte una fecha en formato MM/DD/YYYY a un objeto Date para comparaci√≥n.
     */
    function parseDateMMDDYYYY(dateStr) {
        if (!dateStr) return null;

        const parts = String(dateStr).split('/');
        if (parts.length !== 3) return null;

        const month = parseInt(parts[0], 10);
        const day = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);

        if (isNaN(day) || isNaN(month) || isNaN(year)) return null;

        // Date expects (year, monthIndex, day) - Month is 0-indexed
        const date = new Date(Date.UTC(year, month - 1, day)); 
        
        if (date.getUTCFullYear() !== year || date.getUTCMonth() !== month - 1 || date.getUTCDate() !== day) {
            return null;
        }

        return date;
    }
    
    /**
     * Extrae el n√∫mero entero de una cadena de izquierda a derecha antes del primer espacio.
     */
    function extractIntegerIdBeforeSpace(idString) {
        if (!idString) return '';
        const str = String(idString).trim();
        const spaceIndex = str.indexOf(' ');
        
        if (spaceIndex === -1) {
            return str; 
        }
        return str.substring(0, spaceIndex);
    }
    
    /**
     * Extrae el n√∫mero entero de una cadena de saldo (a la izquierda del primer punto).
     * @param {string} saldoStr La cadena de saldo, e.g., "12345.00" o "123.456".
     * @returns {number} El valor entero.
     */
    function extractIntegerSaldo(saldoStr) {
        if (!saldoStr) return 0;
        const str = String(saldoStr).trim();
        const parts = str.split('.');
        
        let numericStr = parts[0].replace(/[^0-9\-]/g, ''); 
        
        return parseInt(numericStr) || 0;
    }

    function classifyAzzortiFile(file) { 
        const nameLower = file.name.toLowerCase();
        
        if (nameLower.includes('notas')) {
            azzortiFiles.Notas.push(file);
        } else if (nameLower.includes('pagos')) {
            azzortiFiles.Pagos.push(file);
        } else if (nameLower.includes('deud')) {
            azzortiFiles.Deud.push(file);
        } else if (nameLower.includes('obli')) {
            azzortiFiles.Obli.push(file);
        }
    }

    /**
     * Actualiza solo los contadores de archivos, ya no controla el bot√≥n de inicio.
     */
    function updateAzzortiCounts() { 
        document.getElementById('azzortiNotesCount').innerHTML = `**Notas:** ${azzortiFiles.Notas.length} archivos`;
        document.getElementById('azzortiPagosCount').innerHTML = `**Pagos:** ${azzortiFiles.Pagos.length} archivos`;
        document.getElementById('azzortiDeudCount').innerHTML = `**Deudas:** ${azzortiFiles.Deud.length} archivos`;
        document.getElementById('azzortiObliCount').innerHTML = `**Obligaciones:** ${azzortiFiles.Obli.length} archivos`;
    }
    
    /**
     * Carga y parsea el archivo CSV de Cierres de Campa√±a. 
     */
    function loadCierreCampanaFile(file) {
        return new Promise((resolve) => {
            if (!file) {
                cierreCampanaMap.clear();
                return resolve();
            }
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                delimiter: '|', 
                complete: (results) => {
                    cierreCampanaMap.clear();
                    let successCount = 0;
                    const data = results.data;
                    if (!results.meta.fields) { 
                         cierreCampanaStatus.textContent = '‚ö†Ô∏è CSV de Cierres est√° vac√≠o o no es un formato de delimitador v√°lido. (Formato: Campa√±as|Corte|Salida)';
                         cierreCampanaStatus.className = 'alert alert-warning py-1';
                         return resolve(); 
                    }
                    let originalKeyCampanas = null;
                    let originalKeyCorte = null;
                    let originalKeySalida = null;
                    // Detectar las columnas correctas
                    results.meta.fields.forEach(field => {
                        const originalField = String(field);
                        const cleanedField = cleanStringAzzorti(originalField); // USO DE cleanStringAzzorti
                        if (cleanedField.includes('campan') && originalKeyCampanas === null) {
                            originalKeyCampanas = originalField;
                        } else if (cleanedField.includes('corte') && originalKeyCorte === null) {
                            originalKeyCorte = originalField;
                        } else if (cleanedField.includes('salida') && originalKeySalida === null) {
                            originalKeySalida = originalField;
                        }
                    });

                    if (!originalKeyCampanas || !originalKeyCorte || !originalKeySalida) {
                        cierreCampanaStatus.textContent = '‚ùå CSV de Cierres: No se encontraron las columnas requeridas (Campa√±as, Corte, Salida) o el delimitador "|" es incorrecto.';
                        cierreCampanaStatus.className = 'alert alert-danger py-1';
                        return resolve();
                    }

                    data.forEach(row => {
                        const campana = String(row[originalKeyCampanas] || '').trim();
                        const corte = String(row[originalKeyCorte] || '').trim();
                        const salida = String(row[originalKeySalida] || '').trim();

                        if (campana && corte && salida) {
                            const key = `${campana}|${corte}`;
                            cierreCampanaMap.set(key, salida);
                            successCount++;
                        }
                    });

                    if (successCount > 0) {
                        cierreCampanaStatus.textContent = `‚úÖ CSV de Cierres cargado. ${successCount.toLocaleString()} claves de cruce listas.`;
                        cierreCampanaStatus.className = 'alert alert-success py-1';
                    } else {
                        cierreCampanaStatus.textContent = '‚ö†Ô∏è CSV de Cierres cargado, pero no se encontraron filas v√°lidas (Campa√±as, Corte o Salida vac√≠as en los datos).';
                        cierreCampanaStatus.className = 'alert alert-warning py-1';
                    }

                    resolve();
                },
                error: (error) => {
                    cierreCampanaStatus.textContent = `‚ùå Error al parsear el CSV de Cierres. Aseg√∫rese de que el delimitador es '|'. (Detalle: ${error.message})`;
                    cierreCampanaStatus.className = 'alert alert-danger py-1';
                    cierreCampanaMap.clear();
                    resolve();
                }
            });
        });
    }

    /**
     * Procesa un grupo de archivos Azzorti: consolida, extrae metadatos y calcula Etapa. (MODIFICADO para Notas)
     */
    function processAzzortiGroup(files, groupName, fileIndexOffset, totalAzzortiFiles) {
        return new Promise((resolve) => {
            if (files.length === 0) {
                azzortiProcessStatus.innerHTML += ` ‚ö†Ô∏è (Grupo **${groupName}** vac√≠o).`;
                return resolve([]);
            }

            let consolidatedData = [];
            let currentFileIndex = 0;
            const idKey = (groupName === 'Deud') ? AZZORTI_KEY_DEUD : (groupName === 'Obli') ? AZZORTI_KEY_OBLI : null;

            const processNextFile = () => {
                if (currentFileIndex >= files.length) {
                    azzortiProcessStatus.innerHTML += ` ‚úÖ Grupo **${groupName}** completado. Registros: ${consolidatedData.length.toLocaleString()}.`;
                    return resolve(consolidatedData);
                }

                const file = files[currentFileIndex];
                const totalProgressIndex = fileIndexOffset + currentFileIndex + 1;

                azzortiProcessStatus.innerHTML = `‚öôÔ∏è Consolidando **${groupName}**... (${totalProgressIndex}/${totalAzzortiFiles}) - **${file.name}**.`;

                const filePath = file.webkitRelativePath || file.name;
                const baseName = filePath.replace(/\.(txt|csv|dat)$/i, '').toLowerCase();
                const parts = baseName.split('_');

                const metadataObject = {};
                let rawCortePart = "";
                let rawFechaIngresoPart = "";

                parts.forEach((part, index) => {
                    const originalKey = `Part_${index}`;
                    const cleanedPart = part.trim();

                    if (COLUMNS_TO_DELETE.includes(originalKey) || COLUMNS_TO_DELETE.includes(`_${index}`)) {
                        return;
                    }

                    const finalKey = RENAME_MAP[originalKey] || originalKey;
                    
                    if (groupName !== 'Pagos') {
                        metadataObject[finalKey] = cleanedPart;
                        if (finalKey === 'Corte') {
                            rawCortePart = cleanedPart;
                        }
                        if (finalKey === 'Fecha Ingreso') {
                            rawFechaIngresoPart = cleanedPart;
                        }
                    }
                });

                let finalCorte = "";
                let finalEtapa = "";
                
                if (groupName !== 'Pagos') {
                    const isAdministrativa = (rawCortePart === "");
                    if (isAdministrativa) {
                        finalEtapa = "Administrativa";
                        finalCorte = "30"; 
                    } else {
                        finalEtapa = "Comercial";
                        finalCorte = rawCortePart;
                    }
                    const finalFechaIngreso = standardizeDateAzzorti(rawFechaIngresoPart);
                    metadataObject['Corte'] = finalCorte;
                    metadataObject['Etapa'] = finalEtapa;
                    metadataObject['Fecha Ingreso'] = finalFechaIngreso;
                }
                
                Papa.parse(file, {
                    // Si es NOTAS o PAGOS, header: false. Si es DEUD/OBLI, header: true.
                    header: (groupName !== 'Pagos' && groupName !== 'Notas'), 
                    skipEmptyLines: true,
                    delimiter: '|',
                    worker: true,
                    complete: (results) => {
                        let fileData = results.data;
                        let headerRow = null;

                        if (fileData && fileData.length > 0) {
                            
                            if (groupName === 'Notas' || groupName === 'Pagos') {
                                // Para TXT sin encabezado, el PapaParse asume que la primera fila son datos. 
                                // Debemos agregar un encabezado simple o usar el mapeo
                                headerRow = ['FIELD1', 'FIELD2', 'FIELD3', 'FIELD4', 'FIELD5', 'FIELD6', 'FIELD7', 'FIELD8', 'FIELD9', 'FIELD10', 'FIELD11', 'FIELD12', 'FIELD13', 'FIELD14', 'FIELD15', 'FIELD16', 'FIELD17', 'FIELD18', 'FIELD19', 'FIELD20', 'FIELD21', 'FIELD22', 'FIELD23', 'FIELD24', 'FIELD25', 'FIELD26', 'FIELD27', 'FIELD28', 'FIELD29', 'FIELD30'];
                                
                                // Mapeamos el array de arrays a un array de objetos con el encabezado.
                                fileData = fileData.map(rowArray => {
                                    const rowObject = {};
                                    headerRow.forEach((field, index) => {
                                        rowObject[field] = rowArray[index];
                                    });
                                    return rowObject;
                                });
                            }
                            
                            // Si es PAGOS, creamos la columna de ID a partir de FIELD5 y FIELD6
                            if (groupName === 'Pagos') {
                                // FIELD5: NUMERO IDENTIFICACION, FIELD6: CONCEPTO
                                fileData = fileData.map(row => {
                                    row[AZZORTI_KEY_PAGOS] = extractIntegerIdBeforeSpace(row['FIELD5']);
                                    row['CONCEPTO'] = row['FIELD6'];
                                    return row;
                                }).filter(row => row[AZZORTI_KEY_PAGOS] && row[AZZORTI_KEY_PAGOS].length > 0);
                            }

                            // Si es NOTAS, creamos la columna de ID a partir de FIELD2
                            if (groupName === 'Notas') {
                                // FIELD2: NUMERO IDENTIFICACION
                                fileData = fileData.map(row => {
                                    row[AZZORTI_KEY_PAGOS] = extractIntegerIdBeforeSpace(row['FIELD2']);
                                    row['FECHA_NOTA'] = standardizeDateAzzorti(row['FIELD3']);
                                    return row;
                                }).filter(row => row[AZZORTI_KEY_PAGOS] && row[AZZORTI_KEY_PAGOS].length > 0);
                            }
                            
                            let dataWithMetdata = fileData;
                            if (groupName !== 'Pagos' && groupName !== 'Notas') {
                                // Agregar metadatos a cada fila de Deudas/Obligaciones
                                dataWithMetdata = fileData.map(row => ({
                                    ...row, 
                                    ...metadataObject, 
                                    'ID_LIMPIO': extractIntegerIdBeforeSpace(row[idKey]) 
                                }));
                            }

                            consolidatedData.push(...dataWithMetdata);
                        }

                        currentFileIndex++;
                        const percentage = ((totalProgressIndex) / totalAzzortiFiles) * 100;
                        updateProgressBar('azzortiProgressBar', 'azzortiProgressBarContainer', percentage, `Progreso General: ${percentage.toFixed(2)}%`, (percentage === 100));
                        processNextFile();
                    },
                    error: (error) => {
                        console.error(`Error al parsear ${file.name}:`, error);
                        currentFileIndex++;
                        processNextFile();
                    }
                });
            };
            processNextFile();
        });
    }

    // ... (El resto de funciones de Azzorti, executeAzzortiConsolidation, crossDeudasAndObligaciones, aggregatePagos, crossPagosPrincipal, crossFinal, crossNotasFinal) ...
    // Se asume que el resto de las funciones de Azzorti est√°n aqu√≠ y han sido adaptadas para usar cleanStringAzzorti.

    // ----------------------------------------------------------------------
    // --- EVENT LISTENERS (Comfama) ---
    // ----------------------------------------------------------------------
    
    // Comfama: Carga de Pagos
    pagosFolderInput.addEventListener('change', async (event) => {
        const files = Array.from(event.target.files).filter(file => file.size > 0 && (file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.txt')));
        if (files.length === 0) {
            pagosStatus.textContent = 'No se encontraron archivos CSV/TXT v√°lidos en la carpeta.';
            pagosStatus.className = 'alert alert-danger py-1';
            return;
        }
        dataFilePagos = null;¬†
        folderInput.disabled = true; 
        downloadMergeBtn.style.display = 'none';¬†
        await executeComfamaPagosProcess(files); // FUNCI√ìN RENOMBRADA
    });

    // Comfama: Carga de Asignaciones
    folderInput.addEventListener('change', async (event) => {
        if (folderInput.disabled || !dataFilePagos) {
            anexoStatus.textContent = '‚ö†Ô∏è Debe completar el Paso 1 (Pagos) y esperar a que la data est√© en cach√©.';
            anexoStatus.className = 'alert alert-danger py-1';
            return;
        }

        const files = Array.from(event.target.files).filter(file => file.size > 0 && (file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.txt')));
        if (files.length === 0) {
            anexoStatus.textContent = 'No se encontraron archivos CSV/TXT v√°lidos en la carpeta.';
            anexoStatus.className = 'alert alert-danger py-1';
            return;
        }
        
        anexoStatus.textContent = `Archivos de Asignaciones listos. Iniciando proceso...`;
        anexoStatus.className = 'alert alert-info py-1';
        
        downloadMergeBtn.style.display = 'none';
        
        await executeComfamaAsignacionesPreProcess(files); // FUNCI√ìN RENOMBRADA
    });

    // ----------------------------------------------------------------------
    // --- EVENT LISTENERS (Azzorti) ---
    // ----------------------------------------------------------------------

    // Azzorti: Carga de Carpeta Principal
    azzortiFolderInput.addEventListener('change', async (event) => {
        const files = Array.from(event.target.files);
        azzortiFiles = { 'Notas': [], 'Pagos': [], 'Deud': [], 'Obli': [] };
        azzortiConsolidatedData = {
            'Notas': null, 'Pagos': null, 'Deud': null, 'Obli': null, 'Cruze': null, 
            'PagosCruze': null, 'CruzePagosFinal': null, 'CruzeNotasFinal': null
        };
        azzortiDownloadButtons.style.display = 'none';
        updateAzzortiCounts();
        azzortiStatus.textContent = `‚öôÔ∏è ${files.length} archivos detectados. Clasificando...`;
        azzortiStatus.className = 'alert alert-warning py-1';
        let cierreCampanaFile = null;

        files.forEach(file => {
            const nameLower = file.name.toLowerCase();
            if (file.size > 0 && nameLower.endsWith('.csv') && nameLower.includes('cierres')) {
                cierreCampanaFile = file;
            } else if (file.size > 0 && (nameLower.endsWith('.txt') || nameLower.endsWith('.csv') || nameLower.endsWith('.dat'))) {
                classifyAzzortiFile(file);
            }
        });

        updateAzzortiCounts();
        
        if (azzortiFiles.Deud.length === 0 || azzortiFiles.Obli.length === 0) {
            azzortiStatus.textContent = '‚ùå ERROR: Faltan archivos clave (Deud y/u Obli) para iniciar el proceso.';
            azzortiStatus.className = 'alert alert-danger py-1';
            return;
        }

        // Cargar archivo de Cierres
        await loadCierreCampanaFile(cierreCampanaFile);

        // Iniciar el proceso de consolidaci√≥n autom√°ticamente (executeAzzortiConsolidation debe estar definido)
        azzortiStatus.textContent = `‚úÖ Clasificaci√≥n completada. Iniciando consolidaci√≥n...`;
        azzortiStatus.className = 'alert alert-success py-1';
        azzortiProcessStatus.style.display = 'block';
        updateProgressBar('azzortiProgressBar', 'azzortiProgressBarContainer', 0, 'Iniciando consolidaci√≥n de grupos...');
        
        // await executeAzzortiConsolidation(); // La funci√≥n completa de Azzorti debe ser llamada aqu√≠.
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
